import{t as e}from"./database-BGZyZyq9.js";import{i as t,r as n}from"./signals-core.module-PplyFw7G.js";var r=(e,...t)=>Object.assign(e,...t.map(t=>typeof t==`function`?t(e):t)),i=(e,t,...r)=>n(`a`,{href:t,target:`_blank`,rel:`noopener noreferrer`},t=>e.split(/[ \.]/).forEach(e=>e&&t.classList.add(e)),...r),a={},o=(e={})=>({keep:!0,attributes:new Map(Object.entries({...a,...e}))}),s=new Map(Object.entries({DIV:o(),SPAN:o({translate:!1,class:!0}),P:o(),BR:o(),I:o(),B:o(),U:o(),STRONG:o(),EM:o(),UL:o(),OL:o(),LI:o()}));function*c(e,t){for(let n of e.attributes)switch(t.get(n.name)){case void 0:console.warn(`skipping attribute`,n);break;case!0:yield n;break;case!1:break}}function*l(e){for(let n of e)if(n instanceof Text)yield n.textContent;else if(n instanceof HTMLAnchorElement)yield i(``,n.href,l(n.childNodes));else if(n instanceof HTMLElement){let e=s.get(n.tagName);switch(e?.keep){case void 0:console.warn(`skipping element`,n);break;case!0:yield t(n.tagName,c(n,e.attributes),l(n.childNodes));break;case!1:break}}else console.warn(`skipping node`,n)}var u=new DOMParser;function*d(e){try{yield*l(u.parseFromString(e,`text/html`).body.childNodes)}catch{yield n(`div.sanitization-error`,`[Error sanitizing "${e}"`)}}var f=(e,t)=>{let n=r(new BroadcastChannel(e),{onmessage(e){let[n,...r]=e.data;t[n](...r)}});return new Proxy({},{get:(e,r)=>(...e)=>{n.postMessage([r,...e]),t[r](...e)}})},p=e=>e.edited_at?`${e.id}@${e.edited_at}`:e.id,m=await e,h=f(`followToots`,{async updatedTreeOverview(e){console.log(`overview`,await m.get(`treeOverview`,e))},async updatedTree(e){console.log(`details`,await m.get(`treeDetails`,e))},async deletedTree(e){console.log(`deleted`,e)},cleared(){console.log(`cleared`)}});async function g(e,t){try{let n=`${e}/${t}`,i=`https://${e}/api/v1/statuses/${t}`,a=i+`/context`,o=`

* Does the instance "${e}"
  have a toot with id "${t}"?
* Is that toot public or accessible with
  an access token you have provided for
  ${e}?
* And of course: Is there network connectivity
  between you and ${e}?
`;{let{store:i}=m.transaction(`treeOverview`,`readwrite`);await i.put(r(await i.get(n)??{seenIds:new Set},{key:n,instance:e,id:t,lastRequestDate:new Date}))}h.updatedTreeOverview(n);let s={},c=(await m.get(`accessTokens`,e))?.token;c!==void 0&&(s.headers={Authorization:`Bearer ${c}`});let l=await fetch(i,s);if(!l.ok)throw alert(`Could not fetch toot ${t} from ${e} (HTTP status code ${l.status}).${o}`),`Could not fetch toot ${t} from ${e}.`;let u=await l.json(),d=await fetch(a,s);if(!d.ok)throw alert(`Could not fetch context (replies) for toot ${t} from ${e} (HTTP status code ${l.status}).${o}`),`Could not fetch context (replies) for toot ${t} from ${e}.`;let f=await d.json(),{ancestors:p,descendants:g}=f;g.sort((e,t)=>e.created_at<t.created_at?-1:e.created_at>t.created_at?1:0);{let e=m.transaction([`treeOverview`,`treeDetails`],`readwrite`),t=e.objectStore(`treeOverview`),i=await t.get(n)??{},a=u.spoiler_text||_(u.content);a.length>140&&(a=a.substring(0,140)+`...`),await t.put(r(i,{key:n,lastRetrievalDate:new Date,nToots:p.length+1+g.length,nUnseen:y([...p,u,...g],i.seenIds),rootCreatedAt:new Date(u.created_at),lastCreatedAt:new Date((g.at(-1)??u).created_at),rootAuthor:u.account.display_name,rootAuthorAvatar:u.account.avatar_static,rootAccountEmojis:u.account.emojis,rootAcct:u.account.acct,teaser:a})),await e.objectStore(`treeDetails`).put({key:n,root:u,...f})}h.updatedTree(n)}catch(e){console.error(e)}}function _(e){let t=new Document().createElement(`div`);return t.append(...d(e)),t.textContent}var v=(e,t)=>e.reduce((e,n)=>e+Number(t(n)),0),y=(e,t)=>v(e,e=>!t.has(p(e)));async function b(e){let t=m.transaction([`treeOverview`,`treeDetails`],`readwrite`),n=await t.objectStore(`treeDetails`).get(e.key);if(!n)return;let{root:r,ancestors:i,descendants:a}=n;await t.objectStore(`treeOverview`).put({...e,nUnseen:y([...i,r,...a],e.seenIds)}),h.updatedTreeOverview(e.key)}async function x({key:e,rootAuthor:t}){if(!confirm(`Really unfollow toot ${e} by ${t}?\n\nThis will not only remove the toot tree from this application, but it will also forget which toots you have already seen.`))return;let n=m.transaction([`treeOverview`,`treeDetails`],`readwrite`);await Promise.all([n.objectStore(`treeOverview`).delete(e),n.objectStore(`treeDetails`).delete(e)]),h.deletedTree(e)}async function S(){let e=await m.getAll(`treeOverview`);await Promise.all(e.map(({instance:e,id:t})=>g(e,t)))}async function C(){if(!confirm(`Really unfollow all toots?`))return;let e=m.transaction([`treeOverview`,`treeDetails`],`readwrite`);await Promise.all([e.objectStore(`treeOverview`).clear(),e.objectStore(`treeDetails`).clear()]),h.cleared()}var w=e=>{let t=new URL(e);switch(t.origin){case`https://phanpy.social`:{let n=t.hash.split(`/`);return O(e,t.pathname===`/`&&t.search===``&&n.length===4&&n[0]===`#`&&n[2]===`s`,n[1],n[3])}case`https://elk.zone`:{let n=t.pathname.split(`/`);return O(e,n.length===4&&n[0]===``&&T.test(n[2])&&t.search===``&&t.hash===``,n[1],n[3])}default:{if(t.pathname.endsWith(`/tree.html`)&&t.hash){let e=new URLSearchParams(`?`+t.hash.substring(1)),n=e.get(`instance`),r=e.get(`id`);if(n&&r&&D.test(r)){if(t.origin===location.origin){alert(`
              While taking over a toot tree from another follow-toots
              installation is supported,
              it was probably a mistake to apply the bookmarklet to
              the same installation.
            `.replaceAll(/\s+/g,` `));return}return[n,r]}}let n=t.pathname.split(`/`);return n[1]===`users`?O(e,n.length===5&&n[0]===``&&E.test(n[2])&&n[3]===`statuses`,t.host,n[4]):(n[1]===`deck`&&n.splice(1,1),O(e,n.length===3&&n[0]===``&&T.test(n[1]),t.host,n[2]))}}},T=/^@[-_a-z0-9]+(@[-_a-z0-9\.]+)?$/i,E=/^[-_a-z0-9]+$/i,D=/^\d+$/,O=(e,t,n,r)=>t&&D.test(r)||confirm(`The URL "${e}" does not look like an URL identifying a single toot.

Use it nevertheless?

(The mastodon instance would be "${n}" and the toot id would be "${r}".)`)?[n,r]:void 0;function*k(e,t=[]){if(t===null){yield e;return}let r=e.indexOf(`:`,0);if(r<0){yield e;return}let i=0;for(;;){let a=r+1,o=e.indexOf(`:`,a);if(o===a){r++;continue}if(o<0)break;let s=e.substring(a,o),c=t.find(e=>e.shortcode===s);if(!c){if(r=o,(r=e.indexOf(`:`,r+1))<0)break;continue}if(yield e.substring(i,r),yield n(`img.custom-emoji`,{src:c.static_url,alt:s,title:s,draggable:!1}),i=o+1,r=e.indexOf(`:`,i),r<0)break}yield e.substring(i)}function A(e){function t(n){for(let r of n.childNodes)if(r instanceof HTMLElement)t(r);else if(r instanceof Text){let t=[...k(r.data,e)];if(t.length===1&&typeof t[0]==`string`)continue;let i=new DocumentFragment;i.append(...t),n.replaceChild(i,r)}else console.error(`unexpected value to emojify:`,r)}return t}var j=e=>e?new Date(e).toLocaleString(`sv`):`-`;export{x as a,S as c,f as d,d as f,w as i,b as l,r as m,A as n,C as o,i as p,k as r,g as s,j as t,p as u};