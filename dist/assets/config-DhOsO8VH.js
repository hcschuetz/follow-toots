import"./nav-CZS_fpMP.js";import{t as e}from"./database-BGZyZyq9.js";import{a as t,n,r,t as i}from"./signals-core.module-PplyFw7G.js";import{r as a,t as o}from"./linkConfigConfig-YtmXU9nm.js";var s=await e,c=new BroadcastChannel(`hideUrlInput`),l=document.querySelector(`#hide-url-input`);l.onchange=async()=>{await s.put(`config`,{key:`hide-url-input`,value:l.checked}),c.postMessage(null)};async function u(){l.checked=(await s.get(`config`,`hide-url-input`))?.value??!1}c.onmessage=u,u();var d=(e,t)=>Object.fromEntries(Object.entries(e).map(([e,n])=>[e,t(n,e)])),f=document.querySelector(`#config-links`),p=d(a,()=>d(o,()=>n(!1)));{let t=await e;async function n(){let e=(await t.get(`config`,`links`))?.value;e&&Object.entries(p).forEach(([t,n])=>{Object.entries(n).forEach(([n,r])=>{r.value=e[t]?.[n]??!1})})}await n();let r=new BroadcastChannel(`linkConfig`);r.onmessage=n,i(()=>{let e=d(p,e=>d(e,e=>e.value));t.put(`config`,{key:`links`,value:e}),r.postMessage(null)})}t(f,r(`div.bold.client-name`,`Frontend`),...Object.values(a).map(e=>r(`div.bold`,e)),...Object.entries(o).flatMap(([e,t])=>[r(`span.client-name`,r(`img`,{src:t.icon}),r(`span`,t.name(`standard mastodon client`))),...Object.keys(a).map(t=>{let n=p[t][e],a=r(`input`,{type:`checkbox`,"@change":()=>n.value=a.checked});return i(()=>{a.checked=n.value}),a})]));var m=document.querySelector(`#access-tokens`),h=r(`button`,`‚úó Remove All`,{async onclick(){confirm(`Really remove all tokens?`)&&(await y.clear(`accessTokens`),await x())}}),g=r(`input.access-instance`,{type:`text`,placeholder:`e.g. "mastodon.social"`}),_=r(`input.access-token`,{type:`text`,placeholder:`(typically 43 characters)`}),v=r(`button.access-save`,`+ Save`),y=await e,b=new BroadcastChannel(`accessTokens`);b.onmessage=C;async function x(){b.postMessage(null),await C()}await A();var S=r(`button`,`Acquire`);async function C(){let e=await y.getAll(`accessTokens`);h.disabled=e.length===0,t(m,r(`span.bold`,`Instance`),r(`span.bold`,`Token`),r(`span.view-all`,`üëÅ`),h,r(`span.dummy`),...e.map(({instance:e,token:t})=>r(`div.contents.row`,r(`span.access-instance`,e),r(`span.access-token`,t),r(`span.view`,`üëÅ`),r(`button`,`‚úó Remove`,{async onclick(){confirm(`Really remove token for "${e}"?`)&&(await y.delete(`accessTokens`,e),window.sessionStorage.removeItem(`credentials:`+e),await x())}}),r(`button`,`Edit`,{onclick(){g.value=e,_.value=t,g.dispatchEvent(new InputEvent(`input`)),w()}}))),g,_,r(`span.dummy`),v,S)}await C();function w(){v.disabled=!g.value.trim()||!_.value.trim()}g.addEventListener(`input`,w),_.addEventListener(`input`,w),w();async function T(){let e=g.value.trim(),t=_.value.trim();if(!e||!t){alert(`Fill in the fields before clicking "Save"`);return}await y.get(`accessTokens`,e)&&!confirm(`Overwrite token for "${e}"?`)||(await y.put(`accessTokens`,{instance:e,token:t}),g.value=``,_.value=``,w(),g.focus(),await x())}v.onclick=T;function E(e){e.key===`Enter`&&!v.disabled&&(T(),e.stopImmediatePropagation(),e.preventDefault())}g.addEventListener(`keypress`,E),_.addEventListener(`keypress`,E);var D=`read:statuses read:follows read:accounts`;async function O(){let e=g.value;if(!e){alert(`No instance given`);return}let t=await fetch(`https://${e}/api/v1/apps`,{method:`POST`,headers:{"Content-Type":`application/json`},body:JSON.stringify({client_name:`Follow Toots`,redirect_uris:document.location.href,scopes:D,website:document.location.href})});if(!t.ok){alert(`Application registration failed.`);return}let{client_id:n,client_secret:r}=await t.json(),i=JSON.stringify({client_id:n,client_secret:r});window.sessionStorage.setItem(`credentials:`+e,i),document.location=`https://${e}/oauth/authorize?`+new URLSearchParams({response_type:`code`,client_id:n,redirect_uri:document.location.origin+document.location.pathname,scope:D,state:e,lang:`en`})}function k(){S.disabled=!g.value}g.addEventListener(`input`,k),k(),S.addEventListener(`click`,O);async function A(){let e=new URLSearchParams(document.location.search),t=e.get(`state`),n=e.get(`code`),r=e.get(`error`),i=e.get(`error_description`);if(r){window.history.replaceState({},``,document.location.pathname),m.scrollIntoView({behavior:`smooth`,block:`center`}),alert(`Error: ${r}\n\n${i}`);return}if(!(t&&n))return;let a=window.sessionStorage.getItem(`credentials:`+t);if(!a){alert(`Credentials missing`);return}let{client_id:o,client_secret:s}=JSON.parse(a);if(!(o&&s)){alert(`Credentials not parseable`);return}let c=await fetch(`https://${t}/oauth/token`,{method:`POST`,headers:{"Content-Type":`application/json`},body:JSON.stringify({grant_type:`authorization_code`,client_id:o,client_secret:s,redirect_uri:document.location.href,code:n})});if(!c.ok){alert(`Could not get a token from ${t}`);return}let{token_type:l,access_token:u}=await c.json();if(l!==`Bearer`){alert(`unexpected token type: ${l}`);return}await y.put(`accessTokens`,{instance:t,token:u}),b.postMessage(null),window.history.replaceState({},``,document.location.pathname),m.scrollIntoView({behavior:`smooth`,block:`center`}),alert(`Saved new access token for "${t}".`)}