import"./nav-LWwRPReH.js";import{t as e}from"./database-BGZyZyq9.js";import{a as t,d as n,f as r,i,l as a,n as o,p as s,r as c,s as l,t as u,u as d}from"./formatDate-BBJ6jikc.js";import{a as f,i as p,n as m,o as h,r as g,t as ee}from"./signals-core.module-PplyFw7G.js";import{n as te,r as ne,t as re}from"./linkConfigConfig-YtmXU9nm.js";var ie=`.menu {\r
  position: relative;\r
  display: inline-block;\r
  > summary {\r
    padding-inline: 3px;\r
    border-radius: 3px;\r
    cursor: default;\r
    &::marker {\r
      content: "";\r
    }\r
    &:hover {\r
      background-color: #0003;\r
    }\r
  }\r
  > .items {\r
    position: absolute;\r
    top: 100%;\r
    z-index: 1;\r
\r
    border: 1px solid #444;\r
    border-radius: 3px;\r
    padding: 2px;\r
    width: max-content;\r
    background-color: #ccc;\r
\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,_=new CSSStyleSheet;_.replaceSync(ie);var ae=class extends HTMLElement{close;constructor(){super();let e=g(`details.menu`,g(`summary`,`☰`),g(`div.items`,g(`slot`))),t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(_),t.append(e),e.ontoggle=()=>{e.open&&(e.onkeydown=({key:t})=>{t===`Escape`&&(e.open=!1)})},this.close=t=>{e.open&&(e.open=!1,t.preventDefault())}}connectedCallback(){document.addEventListener(`click`,this.close)}disconnectedCallback(){document.removeEventListener(`click`,this.close)}};window.customElements.define(`drop-down-menu`,ae);var oe=`.context-menu {\r
  position: fixed;\r
  top: 100;\r
  left: 100;\r
  width: max-content;\r
  z-index: 1000;\r
  display: none;\r
  list-style: none;\r
  border-radius: 3px;\r
  border: 1px solid #444;\r
  padding: 2px;\r
  background-color: #ccc;\r
  &.open {\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,v=new CSSStyleSheet;v.replaceSync(oe);var y=class e extends HTMLElement{static disabled=!1;open;close;constructor(){super();let t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(v);let n=g(`div.context-menu`,g(`slot`));n.setAttribute(`tabindex`,`0`),t.append(n),this.open=t=>{e.disabled||(t.preventDefault(),n.style.left=t.clientX+`px`,n.style.top=t.clientY+`px`,n.classList.add(`open`),n.focus(),n.onkeydown=({key:e})=>{e===`Escape`&&this.close()},document.addEventListener(`click`,this.close))},this.close=()=>{n.classList.remove(`open`),document.removeEventListener(`click`,this.close),document.removeEventListener(`contextmenu`,this.close)}}connectedCallback(){this.parentElement.addEventListener(`contextmenu`,this.open)}disconnectedCallback(){this.close(),this.parentElement.removeEventListener(`contextmenu`,this.open)}};window.customElements.define(`context-menu`,y);var b=class extends HTMLElement{#e=g(`span.contents.prefix`);#t=g(`input.seen`,{type:`checkbox`,onchange:()=>this.seen=this.seen,title:`Mark toot as seen/unseen`});#n=p(`drop-down-menu`);#r=g(`span`);#i=g(`div.contents`);set headerPrefix(e){f(this.#e,e)}get seen(){return this.#t.checked}set seen(e){this.#t.checked=e,this.#r.textContent=e?`☐ Mark toot as unseen`:`☑ Mark toot as seen`,this.onseenchange?.(new CustomEvent(`seenchanged`,{detail:this.seen}))}onseenchange;set dropDownMenuItems(e){f(this.#n,e)}set contextMenuItems(e){f(this.#i,e)}focus=e=>this.firstElementChild.focus(e);constructor(e){super();let{account:t,poll:n,card:i}=e;this.append(g(`div`,{className:`toot visibility-${e.visibility}`,tabIndex:0,onkeydown:e=>this.onkeydown?.(e)},p(`context-menu`,g(`button.menu-entry-with-key-hint`,{onclick:()=>{this.seen=!this.seen,setTimeout(()=>{this.scrollIntoView({block:`center`,behavior:`smooth`})},100)}},this.#r,g(`span`,`↩`)),this.#i),g(`div.toot-head`,this.#e,this.#t,this.#n,g(`span.visibility`,e.visibility),e.edited_at?[g(`span.toot-created.line-through`,u(e.created_at)),g(`span.toot-edited`,u(e.edited_at))]:g(`span.toot-created`,u(e.created_at)),g(`img.toot-author-avatar`,{src:t.avatar_static}),g(`span.toot-author`,c(t.display_name,t.emojis)),g(`span.toot-acct`,`@`+t.acct)),()=>{let t=g(`div.toot-body`,g(`div.toot-content`,r(e.content),o(e.emojis)),e.media_attachments?.length?()=>{let t=g(`ul.attachments`,e.media_attachments.map(e=>g(`li.attachment`,g(`img.preview`,{src:e.preview_url,alt:e.description??``,title:e.description??``}),e.url&&s(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?g(`details.sensitive`,g(`summary`),t):t}:void 0,n&&g(`div.poll`,g(`ul.poll`,n.options.map((e,t)=>g(`li.poll-option`,g(`span.poll-option-title`,(n.own_votes??[]).includes(t)?n.multiple?`☑`:`⦿︎`:n.multiple?`☐`:`⚪︎`,` `,e.title),g(`span.poll-option-votes`,e.votes_count?.toString(),`/`,n.voters_count?.toString())))),n.voters_count===n.votes_count?null:g(`div.poll-votes-count`,`total votes: `,n.votes_count.toString()),g(`div.poll-expiry`,e=>e.classList.add(n.expired?`poll-expired`:`poll-ongoing`),n.expires_at&&u(n.expires_at))),i&&g(`div.card`,i.image?g(`img.card-image`,{src:i.image,alt:i.image_description??``,title:i.image_description??``,width:i.width??void 0,height:i.height??void 0}):void 0,function*(){i.provider_name&&(yield i.provider_url?s(`card-provider`,i.provider_url,i.provider_name):i.provider_name),yield s(`card-title`,i.url,i.title);let e=(i.authors??[]).filter(e=>e.name);switch(e.length){case 0:i.author_name&&(yield g(`span`,`by `,i.author_url?s(`card-author`,i.author_url,i.author_name):i.author_name));break;case 1:{let{name:t,url:n}=e[0];yield g(`span`,`by `,s(`card-author`,n,t));break}default:yield`by`,yield g(`ul.card-authors`,function*(){for(let{name:t,url:n}of e)yield g(`li`,s(`card-author`,n,t))});break}i.description&&g(`div.card-description`,i.description)}));return e.spoiler_text&&(t=g(`details`,g(`summary`,e.spoiler_text),t)),t.classList.add(`toot-full-body`),t}))}};window.customElements.define(`rendered-toot`,b);function x(e,t,n){let r=e instanceof Array?e:[...e],i=r.length,a=r.findIndex(e=>e===t),o=a;do{o=(o+1)%i;let e=r[o];if(n(e))return e}while(o!==a)}function se(e,t,n){return x([...e].reverse(),t,n)}var S=new class{disposers=[];register(e){this.disposers.push(e)}disposeAll(){for(let e of this.disposers)e();this.disposers.length=0}};function C(e){S.register(ee(e))}var w=await e,T=new URLSearchParams(location.hash.substring(1));try{let e=T.get(`url`);if(e){let[t,n]=i(e)??ce();T.delete(`url`),T.set(`instance`,t),T.set(`id`,n),window.history.replaceState({},``,`#`+T),await w.get(`treeOverview`,`${t}/${n}`)||l(t,n)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function ce(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var E=T.get(`instance`),D=T.get(`id`),O=`${E}/${D}`;n(`followToots`,{async updatedTreeOverview(e){e===O&&$(!1)},async updatedTree(e){e===O&&$(!0)},async deletedTree(e){e===O&&$(!0)},cleared(){$(!0)}});var k,A,j=[],M=new Map;async function le(){k&&a({...k,seenIds:new Set})}async function ue(){k&&A&&a({...k,seenIds:new Set(j.map(e=>d(e)))})}var N=m(void 0,{name:`linkConfig`});async function P(){N.value=(await w.get(`config`,`links`)).value}new BroadcastChannel(`linkConfig`).addEventListener(`message`,P),P();var F=document.querySelector(`#context-menu`);{function e(){y.disabled=!F.checked}F.onchange=e,e()}var I=new Map,L=[];function R(e,t){L.push(e);let n=I.get(e);return n.headerPrefix=t,n}function z(e){if(!e)return;let t=I.get(e);t&&(t.focus({preventScroll:!0}),t.scrollIntoView({block:`center`,behavior:`smooth`}))}function B(e){let t=L.findIndex(t=>t===e);t<0||z(L[(t+1)%L.length])}function V(e){let t=L.length,n=L.findIndex(t=>t===e);n<0||z(L[(n-1+t)%t])}function H(e){z(x(L,e,e=>!M.get(d(e))?.value))}function U(e){z(se(L,e,e=>!M.get(d(e))?.value))}var W=(e,t,n)=>g(`button.menu-entry-with-key-hint`,g(`span`,e),g(`span`,t),{onclick:n}),G=e=>[W(`Previous unseen toot`,`Ctrl-⬆️`,()=>U(e)),W(`Previous toot`,`⬆️`,()=>V(e)),W(`Next toot`,`⬇️`,()=>B(e)),W(`Next unseen toot`,`Ctrl-⬇️`,()=>H(e)),g(`div.contents`,t=>{C(()=>{let n=N.value;n&&f(t,function*(){for(let t of te){let r=n[t];for(let n in r)if(r[n]){let r=re[n],i=r.urlFunctions[t](E,e);yield g(`button.open-link`,{onclick:()=>window.open(i)},g(`img.link-icon`,{src:r.icon}),` Open ${ne[t].toLowerCase()} on ${r.name(E)}`)}}})})}),g(`button.follow-toot`,{onclick:()=>{let t=new URL(`./tree.html`,document.location.href);t.hash=new URLSearchParams({url:`https://${E}/@${e.account.acct}/${e.id}`}).toString(),window.open(t)}},`Follow toot`)],de=(e,t)=>n=>{if(!n.shiftKey){switch(n.key){case`ArrowRight`:n.ctrlKey?H(e):B(e);break;case`ArrowLeft`:n.ctrlKey?U(e):V(e);break;case`Enter`:t.value=!t.value;break;default:return}n.preventDefault(),n.stopImmediatePropagation()}},K=document.querySelector(`#toot-tree`),q=document.querySelector(`#ancestors`),J=document.querySelector(`#descendants`);function fe(e,t){let n=e.findIndex(t);return n<0?{rest:e}:{found:e[n],rest:e.toSpliced(n,1)}}function Y(e){let t=e.toot.account.id,n=[];for(let r=e;r;){let{found:e,rest:i}=fe(r.children,e=>e.toot.account.id===t);n.push({toot:r.toot,children:i.map(Y)}),r=e}return n}function pe(){let{ancestors:e,root:t,descendants:n}=A,r=new Map([t,...n].map(e=>[e.id,{toot:e,children:[]}]));for(let e of n)r.get(e.in_reply_to_id)?.children.push(r.get(e.id));let i=Y(r.get(t.id)),a=(e,t)=>e.map(({toot:n,children:r},i)=>g(`li`,e=>{e.classList.add(i===0?`uplink-child`:`uplink-thread`),e.classList.add(t?`bridge`:`no-bridge`)},R(n,e.length===1?void 0:g(`span.thread-pos`,`${i+1}/${e.length}`)),r.length===0?null:g(`ul.toot-list`,r.map((t,n)=>a(t,i<e.length-1||n<r.length-1))))),o=a(i,!1),s=o[0];s.classList.remove(`uplink-child`),e.length>0&&s.classList.add(`uplink-ancestors`),f(J,g(`ul.toot-list`,o))}function me(){let{root:e,descendants:t}=A;f(J,g(`ul.toot-list`,[e,...t].map(e=>g(`li`,R(e)))))}var he=[`hierarchical`,`chronological`],X=m(`hierarchical`,{name:`displayMode`});function Z(e,...t){h(document.querySelector(e),...t)}function Q(e,...t){f(document.querySelector(e),...t)}function ge(){if(!k)return;let{rootAuthor:e,rootAccountEmojis:n,rootAuthorAvatar:r,rootAcct:i,rootCreatedAt:a,lastCreatedAt:o,lastRetrievalDate:s,nToots:d,nUnseen:f}=k;Q(`#tree-head-name`,e?c(e,n):O),Z(`#tree-head-avatar`,{src:r}),Q(`#tree-head-acct`,i?`@${i} on ${E}`:``),Q(`#tree-head-date-from`,u(a)),Q(`#tree-head-date-to`,u(o)),Q(`#tree-head-date-fetched`,u(s)),Q(`#n-toots`,d?.toFixed()??`??`),Q(`#n-unseen`,f?.toFixed()??`??`),Z(`#all-seen`,{onclick:()=>ue()}),Z(`#all-unseen`,{onclick:()=>le()}),Z(`#reload`,{onclick:()=>l(E,D)}),Z(`#remove`,{onclick:()=>t(k)}),Z(`#display-mode`,{onchange:e=>X.value=e.currentTarget.value})}function _e(){Q(`#toot-id`,D),Q(`#toot-instance`,E),Z(`#follow`,{onclick:()=>l(E,D)}),q.replaceChildren(),J.replaceChildren()}function ve(){f(q,g(`ul.toot-list`,A.ancestors.map(e=>g(`li`,R(e)))))}async function ye(){let e=new Map;for(let t of j){let n=e.get(t.account.acct);n?n.n++:e.set(t.account.acct,{n:1,account:t.account})}let t=[...e.values()];t.sort((e,t)=>t.n-e.n),Q(`#n-users`,t.length.toString()),Q(`#user-stats`,t.map(({n:e,account:t})=>g(`span`,g(`img`,{src:t.avatar_static,title:`${t.display_name} @${t.acct}`}),e>1?e.toString():null))),S.disposeAll(),M.clear();for(let e of j){let t=d(e),n=m(k?.seenIds.has(t)??!1);C(()=>{let e=n.value??!1;if(!k)return;let{seenIds:r}=k;r.has(t)!==e&&(e?r.add(t):r.delete(t),a(k))}),M.set(t,n)}I.clear();for(let e of j){let t=M.get(d(e)),n=h(new b(e),{contextMenuItems:G(e),dropDownMenuItems:G(e),onseenchange:e=>t.value=e.detail,onkeydown:de(e,t)});C(()=>{n.seen=t.value}),I.set(e,n)}L.length=0,ve(),C(()=>{L.length=A.ancestors.length;let e=X.value;switch(K.classList.remove(...he),K.classList.add(e),e){case`hierarchical`:pe();break;case`chronological`:me();break;default:J.replaceChildren(`Oops`);break}}),z(A?.root)}async function $(e){if(k=await w.get(`treeOverview`,O),Z(`#app`,{hidden:!k}),Z(`#not-following`,{hidden:!!k}),!k){_e();return}if(document.title=`${k.rootAuthor}: "${k.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=k.rootAuthorAvatar??``,ge(),e){if(A=await w.get(`treeDetails`,O),!A){document.title=k.rootAuthor??`Follow Toot`;return}let{ancestors:e,root:t,descendants:n}=A;j=[...e,t,...n],await ye()}else{if(!A)return;let{seenIds:e}=k;for(let t of j){let n=d(t),r=M.get(n);r?r.value=e.has(n):console.warn(`Misssing "seen" signal for toot ${n}`)}}}$(!0);