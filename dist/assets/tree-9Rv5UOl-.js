import{r as e,t}from"./H-DvoLG5ED.js";import{c as n,d as r,i,l as a,n as o,o as s,r as c,t as l,u}from"./emojify-YCKR0-Hy.js";import{i as d,r as f,t as p}from"./linkConfigConfig-6AgJfi2T.js";function m(e,n,i,a,s,c){let{account:d,poll:f,card:m}=e,h=a=>t(`span.contents`,o=>{i(i=>{o.replaceChildren();let s=i?.[a]??{};for(let i in s)s[i]&&o.append(r(`icon-link`,p[i].urlFunctions[a](n,e),t(`img.link-icon`,{src:p[i].icon})))})}),g;return t(`div`,{className:`toot visibility-${e.visibility}`},t(`div.toot-head`,c,g=a&&t(`button.close-open`,{"@click":a}),h(`status`),t(`span.visibility`,`[${e.visibility}]`),t(`span.toot-created`,new Date(e.created_at).toLocaleString(`sv`)),t(`img.toot-author-avatar`,{src:d.avatar_static}),t(`span.toot-author`,o(d.display_name,d.emojis)),t(`span.toot-acct`,`@`+d.acct),h(`profile`)),()=>{let n=t(`div.toot-body`,t(`div.toot-content`,...u(e.content),l(e.emojis)),e.media_attachments?.length?()=>{let n=t(`ul.attachments`,...e.media_attachments.map(e=>t(`li.attachment`,t(`img.preview`,{src:e.preview_url,title:e.description??void 0}),e.url&&r(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?t(`details.sensitive`,t(`summary`),n):n}:void 0,f&&t(`div.poll`,t(`ul.poll`,...f.options.map((e,n)=>t(`li.poll-option`,t(`span.poll-option-title`,(f.own_votes??[]).includes(n)?f.multiple?`☑`:`⦿︎`:f.multiple?`☐`:`⚪︎`,` `,e.title),t(`span.poll-option-votes`,e.votes_count?.toString(),`/`,f.voters_count?.toString())))),f.voters_count===f.votes_count?null:t(`div.poll-votes-count`,`total votes: `,f.votes_count.toString()),t(`div.poll-expiry`,e=>e.classList.add(f.expired?`poll-expired`:`poll-ongoing`),f.expires_at&&new Date(f.expires_at).toLocaleString(`sv`))),m&&t(`div.card`,r(`card-title`,m.url,m.title),m.description&&t(`div.card-description`,m.description),m.image?t(`img.card-image`,{src:m.image,alt:m.image_description??void 0}):m.html?t(`div.card-html`,{innerHTML:m.html}):void 0));return e.spoiler_text&&(n=t(`details`,t(`summary`,e.spoiler_text),n)),n.classList.add(`toot-full-body`),s?s(e=>{g.textContent=e?`+`:`−`,n.hidden=e}):n.hidden=!0,n})}var h=new URLSearchParams(location.hash.substring(1));try{let t=h.get(`url`);if(t){let[n,r]=c(t)??g();h.delete(`url`),h.set(`instance`,n),h.set(`id`,r),window.history.replaceState({},``,`#`+h),await(await e).get(`treeOverview`,`${n}/${r}`)||s(n,r)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function g(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var _=`${h.get(`instance`)}/${h.get(`id`)}`;a(`followToots`,{async updatedTreeOverview(e){e===_&&V(!1)},async updatedTree(e){e===_&&V(!0)},async deletedTree(e){e===_&&V(!0)},cleared(){V(!0)}});var v=await e,y=d();async function b(){y.value=(await v.get(`treeOverview`,_))?.closedIds}var x=document.querySelector(`#app`),S=document.querySelector(`#ancestors`),C=document.querySelector(`#descendants`);async function w(){let e=await v.get(`treeOverview`,_);e&&(e.closedIds.clear(),n(e))}async function T(){let e=await v.get(`treeOverview`,_);if(!e)return;let t=await v.get(`treeDetails`,_);if(!t)return;let{root:r,descendants:i}=t,{closedIds:a}=e;[r,...i].forEach(e=>a.add(e.id)),n(e)}var E=(e,t)=>async()=>{let r=await v.get(`treeOverview`,t);if(!r)return;let{closedIds:i}=r;i.has(e)?i.delete(e):i.add(e),n(r)},D=e=>t=>{f(()=>{t(y.value?.has(e)??!1)})},O=d();async function k(){O.value=(await v.get(`config`,`links`)).value}var A=e=>{f(()=>{e(O.value)})};new BroadcastChannel(`linkConfig`).addEventListener(`message`,k),k();function j(e){if(e)return t(`li.children-mismatch`,`Mismatch: Found ${Math.abs(e)} ${Math.abs(e)===1?`child`:`children`} ${e<0?`less`:`more`} than expected.`)}function M(e){let{key:n,tootTree:r}=e;function i({toot:e,children:r},a=0){let o=r.find(t=>t.toot.account.id===e.account.id),s=r.filter(e=>e!==o),c=a+1,l=a>0||o?t(`span.thread-pos`,`#${c}`):void 0,[u]=n.split(`/`,1);return[m(e,u,A,E(e.id,n),D(e.id),l),t(`ul.tree-node`,...s.map(e=>t(`li`,...i(e))),j(r.length-e.replies_count)),...o?i(o,c):[]]}C.replaceChildren(...i(r))}async function N(e,n){let{key:r,root:i,descendants:a}=e,[o]=r.split(`/`,1),s=n?a.filter(e=>!y.value?.has(e.id)):a;C.replaceChildren(t(`ul.toot-list`,...[i,...s].map(e=>t(`li`,m(e,o,A,E(e.id,r),D(e.id))))))}var P=[`hierarchical`,`chronological`,`root + open`],F=d(`hierarchical`),I=`Possible reasons for a mismatch between expected and actual number of toots:
- Without authentication Mastodon reports at most 60 descendants.
- Some toots might be non-public.
- Replies or reply counts might not yet be propagated to your instance.
- ...`;function L(e,n,r){let{rootAuthor:a,rootAccountEmojis:c}=e;x.replaceChildren(t(`div.tree-head-author`,t(`img.tree-head-avatar`,{src:e.rootAuthorAvatar}),t(`span.tree-head-name`,a?o(a,c):_),t(`span.tree-head-acct`,e.rootAcct?`@${e.rootAcct} on ${n}`:``)),t(`span.tree-head-date`,e.rootCreatedAt?.toLocaleString(`sv`),` – `,e.lastCreatedAt?.toLocaleString(`sv`),`\u2003last fetched ${e.lastRetrievalDate?.toLocaleString(`sv`)??`-`}`),t(`span.tree-head-statistics`,t(`span`,`${1+(e.nDescendants??0)} toot(s)`),e.nDescendants===e.nExpectedDescendants?``:t(`span.warn`,{title:I},`${(e.nExpectedDescendants??0)+1} expected`),t(`span`,`${e.nOpen??`??`} open`)),t(`div.tree-head-buttons`,t(`button`,{textContent:`[−] Close all`,"@click":()=>T()}),t(`button`,{textContent:`[+] Open all`,"@click":()=>w()}),t(`button`,{textContent:`⟳ Reload`,"@click":()=>s(n,r)}),t(`button`,{textContent:`✗ Remove`,"@click":()=>e&&i(e)})),t(`div.tree-head-choose-mode`,...P.map(e=>t(`label`,t(`input`,{type:`radio`,"@click":()=>{F.value=e}},t=>{f(()=>{t.checked=e===F.value})}),e))))}function R(e,n){x.replaceChildren(t(`div`,`You are currently not following toot ${n} from ${e}. `),t(`div`,t(`button`,{textContent:`Follow`,"@click":()=>s(e,n)}),` it or close this tab.`)),S.replaceChildren(),C.replaceChildren()}function z(e){let n=e.ancestors;if(n.length===0){S.replaceChildren();return}let r=n[0],[i]=_.split(`/`,1);S.replaceChildren(t(`div.root-ancestor`,m(r,i,A),t(`div.more-ancestors`,n.length===1?`↓`:`↓\u2003${n.length-1} more ancestor toot(s)`)))}async function B(e){z(e),f(()=>{switch(F.value){case`hierarchical`:M(e);break;case`chronological`:N(e,!1);break;case`root + open`:N(e,!0);break;default:C.replaceChildren(`Oops`)}})}async function V(e){await b();let[t,n]=_.split(`/`),r=await v.get(`treeOverview`,_);if(!r){R(t,n);return}if(document.title=`${r.rootAuthor}: "${r.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=r.rootAuthorAvatar??``,L(r,t,n),e){let e=await v.get(`treeDetails`,_);if(!e){document.title=r.rootAuthor??`Follow Toot`;return}await B(e)}}V(!0);