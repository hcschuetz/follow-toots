import"./nav-B2g3d2SO.js";import{t as e}from"./database-BGZyZyq9.js";import{a as t,d as n,f as r,i,l as a,n as o,p as s,r as c,s as l,t as u,u as d}from"./formatDate-BldI2TgA.js";import{a as f,n as p,o as m,r as h,t as g}from"./signals-core.module-psBtSSF_.js";import{n as _,t as v}from"./linkConfigConfig-Bp2PAGym.js";var y=`.menu {\r
  position: relative;\r
  display: inline-block;\r
  > summary {\r
    padding-inline: 3px;\r
    border-radius: 3px;\r
    cursor: default;\r
    &::marker {\r
      content: "";\r
    }\r
    &:hover {\r
      background-color: #0003;\r
    }\r
  }\r
  > .items {\r
    position: absolute;\r
    top: 100%;\r
    z-index: 1;\r
\r
    border: 1px solid #444;\r
    border-radius: 3px;\r
    padding: 2px;\r
    width: max-content;\r
    background-color: #ccc;\r
\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,b=class extends HTMLElement{close;constructor(){super();let e;this.attachShadow({mode:`open`}).append(h(`style`,y),e=h(`details.menu`,h(`summary`,`☰`),h(`div.items`,h(`slot`)))),this.close=t=>{e.open&&(console.log(`closing`),e.open=!1,t.preventDefault())}}connectedCallback(){document.addEventListener(`click`,this.close)}disconnectedCallback(){document.removeEventListener(`click`,this.close)}};window.customElements.define(`drop-down-menu`,b);function x(e,t,n,i,a,l){let{account:d,poll:p,card:m}=e;return h(`div`,{className:`toot visibility-${e.visibility}`},h(`div.toot-head`,l,h(`input.seen`,{type:`checkbox`,"@change":i,title:`Mark toot as seen/unseen`},e=>{g(()=>{e.checked=!!a.value})}),h(`drop-down-menu`,r=>{g(()=>{let{value:i}=n;f(r,function*(){for(let n of[`status`,`profile`]){let r=i?.[n]??{};for(let i in r)if(r[i]){let r=v[i],a=r.urlFunctions[n](t,e);yield h(`button.open-link`,{onclick:()=>window.open(a)},h(`img.link-icon`,{src:r.icon}),` Open ${_[n].toLowerCase()} on ${r.name(t)}`)}}yield h(`button.follow-toot`,{onclick:()=>{let n=new URL(`./tree.html`,document.location.href);n.hash=new URLSearchParams({url:`https://${t}/@${e.account.acct}/${e.id}`}).toString(),console.log(n.toString()),window.open(n)}},`Follow toot`)})})}),h(`span.visibility`,e.visibility),e.edited_at?[h(`span.toot-created.line-through`,u(e.created_at)),h(`span.toot-edited`,u(e.edited_at))]:h(`span.toot-created`,u(e.created_at)),h(`img.toot-author-avatar`,{src:d.avatar_static}),h(`span.toot-author`,c(d.display_name,d.emojis)),h(`span.toot-acct`,`@`+d.acct)),()=>{let t=h(`div.toot-body`,h(`div.toot-content`,r(e.content),o(e.emojis)),e.media_attachments?.length?()=>{let t=h(`ul.attachments`,e.media_attachments.map(e=>h(`li.attachment`,h(`img.preview`,{src:e.preview_url,alt:e.description??``,title:e.description??``}),e.url&&s(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?h(`details.sensitive`,h(`summary`),t):t}:void 0,p&&h(`div.poll`,h(`ul.poll`,p.options.map((e,t)=>h(`li.poll-option`,h(`span.poll-option-title`,(p.own_votes??[]).includes(t)?p.multiple?`☑`:`⦿︎`:p.multiple?`☐`:`⚪︎`,` `,e.title),h(`span.poll-option-votes`,e.votes_count?.toString(),`/`,p.voters_count?.toString())))),p.voters_count===p.votes_count?null:h(`div.poll-votes-count`,`total votes: `,p.votes_count.toString()),h(`div.poll-expiry`,e=>e.classList.add(p.expired?`poll-expired`:`poll-ongoing`),p.expires_at&&u(p.expires_at))),m&&h(`div.card`,m.image?h(`img.card-image`,{src:m.image,alt:m.image_description??``,title:m.image_description??``,width:m.width??void 0,height:m.height??void 0}):void 0,function*(){m.provider_name&&(yield m.provider_url?s(`card-provider`,m.provider_url,m.provider_name):m.provider_name),yield s(`card-title`,m.url,m.title);let e=(m.authors??[]).filter(e=>e.name);switch(e.length){case 0:m.author_name&&(yield h(`span`,`by `,m.author_url?s(`card-author`,m.author_url,m.author_name):m.author_name));break;case 1:{let{name:t,url:n}=e[0];yield h(`span`,`by `,s(`card-author`,n,t));break}default:yield`by`,yield h(`ul.card-authors`,function*(){for(let{name:t,url:n}of e)yield h(`li`,s(`card-author`,n,t))});break}m.description&&h(`div.card-description`,m.description)}));return e.spoiler_text&&(t=h(`details`,h(`summary`,e.spoiler_text),t)),t.classList.add(`toot-full-body`),t})}var S=new URLSearchParams(location.hash.substring(1));try{let t=S.get(`url`);if(t){let[n,r]=i(t)??C();S.delete(`url`),S.set(`instance`,n),S.set(`id`,r),window.history.replaceState({},``,`#`+S),await(await e).get(`treeOverview`,`${n}/${r}`)||l(n,r)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function C(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var w=`${S.get(`instance`)}/${S.get(`id`)}`;n(`followToots`,{async updatedTreeOverview(e){e===w&&G(!1)},async updatedTree(e){e===w&&G(!0)},async deletedTree(e){e===w&&G(!0)},cleared(){G(!0)}});var T=await e,E=p(void 0,{name:`seenIds`});async function D(){E.value=(await T.get(`treeOverview`,w))?.seenIds}var O=document.querySelector(`#ancestors`),k=document.querySelector(`#descendants`);async function A(){let e=await T.get(`treeOverview`,w);e&&(e.seenIds.clear(),a(e))}async function j(){let e=await T.get(`treeOverview`,w);if(!e)return;let t=await T.get(`treeDetails`,w);if(!t)return;let{ancestors:n,root:r,descendants:i}=t,{seenIds:o}=e;[...n,r,...i].forEach(e=>o.add(d(e))),a(e)}var M=(e,t)=>async()=>{let n=await T.get(`treeOverview`,t);if(!n)return;let{seenIds:r}=n;r.has(e)?r.delete(e):r.add(e),a(n)},N=p(void 0,{name:`linkConfig`});async function P(){N.value=(await T.get(`config`,`links`)).value}new BroadcastChannel(`linkConfig`).addEventListener(`message`,P),P();function F(e){if(e)return h(`li.children-mismatch`,`Mismatch: Found ${Math.abs(e)} ${Math.abs(e)===1?`child`:`children`} ${e<0?`less`:`more`} than expected.`)}function I(e,t){let{key:n,root:r,descendants:i}=e,a=new Map([r,...i].map(e=>[e.id,{toot:e,children:[]}]));for(let e of i)a.get(e.in_reply_to_id)?.children.push(a.get(e.id));let o=a.get(r.id);function*s({toot:e,children:r},i=0){let a=r.find(t=>t.toot.account.id===e.account.id);r=r.filter(e=>e!==a);let o=i+1,c=i>0||a?h(`span.thread-pos`,`#${o}`):void 0,[l]=n.split(`/`,1);yield h(`li`,x(e,l,N,M(d(e),n),t.get(d(e)),c),r.length===0?null:h(`ul.toot-list`,r.map(e=>s(e)),F(r.length+(a?1:0)-e.replies_count))),a&&(yield*s(a,o))}f(k,h(`ul.toot-list`,s(o)))}function L(e,t){let{key:n,root:r,descendants:i}=e,[a]=n.split(`/`,1);f(k,h(`ul.toot-list`,[r,...i].map(e=>h(`li`,x(e,a,N,M(d(e),n),t.get(d(e)))))))}var R=p(`hierarchical`,{name:`displayMode`});function z(e,...t){m(document.querySelector(e),...t)}function B(e,...t){f(document.querySelector(e),...t)}function V(e,n,r){let{rootAuthor:i,rootAccountEmojis:a}=e;B(`#tree-head-name`,i?c(i,a):w),z(`#tree-head-avatar`,{src:e.rootAuthorAvatar}),B(`#tree-head-acct`,e.rootAcct?`@${e.rootAcct} on ${n}`:``),B(`#tree-head-date-from`,u(e.rootCreatedAt)),B(`#tree-head-date-to`,u(e.lastCreatedAt)),B(`#tree-head-date-fetched`,u(e.lastRetrievalDate)),B(`#n-toots`,e.nToots?.toFixed()??`??`),B(`#n-unseen`,e.nUnseen?.toFixed()??`??`),z(`#all-seen`,{onclick:()=>j()}),z(`#all-unseen`,{onclick:()=>A()}),z(`#reload`,{onclick:()=>l(n,r)}),z(`#remove`,{onclick:()=>e&&t(e)}),z(`#display-mode`,{onchange:e=>R.value=e.currentTarget.value})}function H(e,t){B(`#toot-id`,t),B(`#toot-instance`,e),z(`#follow`,{onclick:()=>l(e,t)}),O.replaceChildren(),k.replaceChildren()}function U(e,t){let[n]=w.split(`/`,1);f(O,h(`ul.toot-list`,e.ancestors.map(e=>h(`li`,x(e,n,N,M(d(e),w),t.get(d(e)))))))}async function W(e){let{ancestors:t,root:n,descendants:r}=e,i=new Map;for(let e of[...t,n,...r]){let t=i.get(e.account.acct);t?t.n++:i.set(e.account.acct,{n:1,account:e.account})}let a=[...i.values()];a.sort((e,t)=>t.n-e.n),B(`#user-stats`,a.map(({n:e,account:t})=>h(`span`,h(`img`,{src:t.avatar_static,title:t.display_name}),e>1?e.toString():null)));let o=new Map([...t,n,...r].map(e=>[d(e),p()]));g(()=>{for(let[e,t]of o)t.value=E.value?.has(e)}),U(e,o),g(()=>{switch(R.value){case`hierarchical`:I(e,o);break;case`chronological`:L(e,o);break;default:k.replaceChildren(`Oops`);break}})}async function G(e){await D();let[t,n]=w.split(`/`),r=await T.get(`treeOverview`,w);if(z(`#app`,{hidden:!r}),z(`#not-following`,{hidden:!!r}),!r){H(t,n);return}if(document.title=`${r.rootAuthor}: "${r.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=r.rootAuthorAvatar??``,V(r,t,n),e){let e=await T.get(`treeDetails`,w);if(!e){document.title=r.rootAuthor??`Follow Toot`;return}await W(e)}}G(!0);