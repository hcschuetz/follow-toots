import"./nav-CQLbYuIg.js";import{t as e}from"./database-BGZyZyq9.js";import{a as t,d as n,f as r,i,l as a,n as o,p as s,r as c,s as l,t as u,u as d}from"./formatDate-BldI2TgA.js";import{a as f,n as p,o as m,r as h,t as g}from"./signals-core.module-psBtSSF_.js";import{n as _,t as v}from"./linkConfigConfig-Bp2PAGym.js";var y=`.menu {\r
  position: relative;\r
  display: inline-block;\r
  > summary {\r
    padding-inline: 3px;\r
    border-radius: 3px;\r
    cursor: default;\r
    &::marker {\r
      content: "";\r
    }\r
    &:hover {\r
      background-color: #0003;\r
    }\r
  }\r
  > .items {\r
    position: absolute;\r
    top: 100%;\r
    z-index: 1;\r
\r
    border: 1px solid #444;\r
    border-radius: 3px;\r
    padding: 2px;\r
    width: max-content;\r
    background-color: #ccc;\r
\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,b=new CSSStyleSheet;b.replaceSync(y);var x=class extends HTMLElement{close;constructor(){super();let e,t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(b),t.append(e=h(`details.menu`,h(`summary`,`☰`),h(`div.items`,h(`slot`)))),this.close=t=>{e.open&&(console.log(`closing`),e.open=!1,t.preventDefault())}}connectedCallback(){document.addEventListener(`click`,this.close)}disconnectedCallback(){document.removeEventListener(`click`,this.close)}};window.customElements.define(`drop-down-menu`,x);function S(e,t,n,i,a,l){let{account:d,poll:p,card:m}=e;return h(`div`,{className:`toot visibility-${e.visibility}`},h(`div.toot-head`,l,h(`input.seen`,{type:`checkbox`,"@change":i,title:`Mark toot as seen/unseen`},e=>{g(()=>{e.checked=!!a.value})}),h(`drop-down-menu`,r=>{g(()=>{let{value:i}=n;f(r,function*(){for(let n of[`status`,`profile`]){let r=i?.[n]??{};for(let i in r)if(r[i]){let r=v[i],a=r.urlFunctions[n](t,e);yield h(`button.open-link`,{onclick:()=>window.open(a)},h(`img.link-icon`,{src:r.icon}),` Open ${_[n].toLowerCase()} on ${r.name(t)}`)}}yield h(`button.follow-toot`,{onclick:()=>{let n=new URL(`./tree.html`,document.location.href);n.hash=new URLSearchParams({url:`https://${t}/@${e.account.acct}/${e.id}`}).toString(),console.log(n.toString()),window.open(n)}},`Follow toot`)})})}),h(`span.visibility`,e.visibility),e.edited_at?[h(`span.toot-created.line-through`,u(e.created_at)),h(`span.toot-edited`,u(e.edited_at))]:h(`span.toot-created`,u(e.created_at)),h(`img.toot-author-avatar`,{src:d.avatar_static}),h(`span.toot-author`,c(d.display_name,d.emojis)),h(`span.toot-acct`,`@`+d.acct)),()=>{let t=h(`div.toot-body`,h(`div.toot-content`,r(e.content),o(e.emojis)),e.media_attachments?.length?()=>{let t=h(`ul.attachments`,e.media_attachments.map(e=>h(`li.attachment`,h(`img.preview`,{src:e.preview_url,alt:e.description??``,title:e.description??``}),e.url&&s(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?h(`details.sensitive`,h(`summary`),t):t}:void 0,p&&h(`div.poll`,h(`ul.poll`,p.options.map((e,t)=>h(`li.poll-option`,h(`span.poll-option-title`,(p.own_votes??[]).includes(t)?p.multiple?`☑`:`⦿︎`:p.multiple?`☐`:`⚪︎`,` `,e.title),h(`span.poll-option-votes`,e.votes_count?.toString(),`/`,p.voters_count?.toString())))),p.voters_count===p.votes_count?null:h(`div.poll-votes-count`,`total votes: `,p.votes_count.toString()),h(`div.poll-expiry`,e=>e.classList.add(p.expired?`poll-expired`:`poll-ongoing`),p.expires_at&&u(p.expires_at))),m&&h(`div.card`,m.image?h(`img.card-image`,{src:m.image,alt:m.image_description??``,title:m.image_description??``,width:m.width??void 0,height:m.height??void 0}):void 0,function*(){m.provider_name&&(yield m.provider_url?s(`card-provider`,m.provider_url,m.provider_name):m.provider_name),yield s(`card-title`,m.url,m.title);let e=(m.authors??[]).filter(e=>e.name);switch(e.length){case 0:m.author_name&&(yield h(`span`,`by `,m.author_url?s(`card-author`,m.author_url,m.author_name):m.author_name));break;case 1:{let{name:t,url:n}=e[0];yield h(`span`,`by `,s(`card-author`,n,t));break}default:yield`by`,yield h(`ul.card-authors`,function*(){for(let{name:t,url:n}of e)yield h(`li`,s(`card-author`,n,t))});break}m.description&&h(`div.card-description`,m.description)}));return e.spoiler_text&&(t=h(`details`,h(`summary`,e.spoiler_text),t)),t.classList.add(`toot-full-body`),t})}var C=new URLSearchParams(location.hash.substring(1));try{let t=C.get(`url`);if(t){let[n,r]=i(t)??w();C.delete(`url`),C.set(`instance`,n),C.set(`id`,r),window.history.replaceState({},``,`#`+C),await(await e).get(`treeOverview`,`${n}/${r}`)||l(n,r)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function w(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var T=`${C.get(`instance`)}/${C.get(`id`)}`;n(`followToots`,{async updatedTreeOverview(e){e===T&&q(!1)},async updatedTree(e){e===T&&q(!0)},async deletedTree(e){e===T&&q(!0)},cleared(){q(!0)}});var E=await e,D=p(void 0,{name:`seenIds`});async function O(){D.value=(await E.get(`treeOverview`,T))?.seenIds}var k=document.querySelector(`#toot-tree`),A=document.querySelector(`#ancestors`),j=document.querySelector(`#descendants`);async function M(){let e=await E.get(`treeOverview`,T);e&&(e.seenIds.clear(),a(e))}async function N(){let e=await E.get(`treeOverview`,T);if(!e)return;let t=await E.get(`treeDetails`,T);if(!t)return;let{ancestors:n,root:r,descendants:i}=t,{seenIds:o}=e;[...n,r,...i].forEach(e=>o.add(d(e))),a(e)}var P=(e,t)=>async()=>{let n=await E.get(`treeOverview`,t);if(!n)return;let{seenIds:r}=n;r.has(e)?r.delete(e):r.add(e),a(n)},F=p(void 0,{name:`linkConfig`});async function I(){F.value=(await E.get(`config`,`links`)).value}new BroadcastChannel(`linkConfig`).addEventListener(`message`,I),I();function L(e,t){let{key:n,root:r,descendants:i}=e,a=new Map([r,...i].map(e=>[e.id,{toot:e,children:[]}]));for(let e of i)a.get(e.in_reply_to_id)?.children.push(a.get(e.id));let o=a.get(r.id);function*s({toot:e,children:r},i,a,o){let c=r.find(t=>t.toot.account.id===e.account.id);r=r.filter(e=>e!==c);let l=o+1,u=o>0||c?h(`span.thread-pos`,`#${l}`):void 0,[f]=n.split(`/`,1);yield h(`li`,e=>{i&&e.classList.add(`uplink-${i}`),a&&e.classList.add(`bridge-${a}`)},S(e,f,F,P(d(e),n),t.get(d(e)),u),r.length===0?null:h(`ul.toot-list`,r.map((e,t)=>s(e,`child`,t<r.length-1?`child`:c?`thread`:null,0)))),c&&(yield*s(c,`thread`,a,l))}f(j,h(`ul.toot-list`,s(o,e.ancestors.length>0?`ancestors`:null,null,0)))}function R(e,t){let{key:n,root:r,descendants:i}=e,[a]=n.split(`/`,1);f(j,h(`ul.toot-list`,[r,...i].map(e=>h(`li`,S(e,a,F,P(d(e),n),t.get(d(e)))))))}var z=[`hierarchical`,`chronological`],B=p(`hierarchical`,{name:`displayMode`});function V(e,...t){m(document.querySelector(e),...t)}function H(e,...t){f(document.querySelector(e),...t)}function U(e,n,r){let{rootAuthor:i,rootAccountEmojis:a}=e;H(`#tree-head-name`,i?c(i,a):T),V(`#tree-head-avatar`,{src:e.rootAuthorAvatar}),H(`#tree-head-acct`,e.rootAcct?`@${e.rootAcct} on ${n}`:``),H(`#tree-head-date-from`,u(e.rootCreatedAt)),H(`#tree-head-date-to`,u(e.lastCreatedAt)),H(`#tree-head-date-fetched`,u(e.lastRetrievalDate)),H(`#n-toots`,e.nToots?.toFixed()??`??`),H(`#n-unseen`,e.nUnseen?.toFixed()??`??`),V(`#all-seen`,{onclick:()=>N()}),V(`#all-unseen`,{onclick:()=>M()}),V(`#reload`,{onclick:()=>l(n,r)}),V(`#remove`,{onclick:()=>e&&t(e)}),V(`#display-mode`,{onchange:e=>B.value=e.currentTarget.value})}function W(e,t){H(`#toot-id`,t),H(`#toot-instance`,e),V(`#follow`,{onclick:()=>l(e,t)}),A.replaceChildren(),j.replaceChildren()}function G(e,t){let[n]=T.split(`/`,1);f(A,h(`ul.toot-list`,e.ancestors.map(e=>h(`li`,S(e,n,F,P(d(e),T),t.get(d(e)))))))}async function K(e){let{ancestors:t,root:n,descendants:r}=e,i=new Map;for(let e of[...t,n,...r]){let t=i.get(e.account.acct);t?t.n++:i.set(e.account.acct,{n:1,account:e.account})}let a=[...i.values()];a.sort((e,t)=>t.n-e.n),H(`#n-users`,a.length.toString()),H(`#user-stats`,a.map(({n:e,account:t})=>h(`span`,h(`img`,{src:t.avatar_static,title:`${t.display_name} @${t.acct}`}),e>1?e.toString():null)));let o=new Map([...t,n,...r].map(e=>[d(e),p()]));g(()=>{for(let[e,t]of o)t.value=D.value?.has(e)}),G(e,o),g(()=>{let t=B.value;switch(k.classList.remove(...z),k.classList.add(t),t){case`hierarchical`:L(e,o);break;case`chronological`:R(e,o);break;default:j.replaceChildren(`Oops`);break}})}async function q(e){await O();let[t,n]=T.split(`/`),r=await E.get(`treeOverview`,T);if(V(`#app`,{hidden:!r}),V(`#not-following`,{hidden:!!r}),!r){W(t,n);return}if(document.title=`${r.rootAuthor}: "${r.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=r.rootAuthorAvatar??``,U(r,t,n),e){let e=await E.get(`treeDetails`,T);if(!e){document.title=r.rootAuthor??`Follow Toot`;return}await K(e)}}q(!0);