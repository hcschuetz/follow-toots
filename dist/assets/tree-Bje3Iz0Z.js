import"./nav-DjbL4ZGQ.js";import{t as e}from"./database-BS-gGBMO.js";import{a as t,d as n,f as r,i,l as a,n as o,r as s,s as c,t as l,u}from"./formatDate-Dq704Nri.js";import{r as d,t as f}from"./H-BDef4IoB.js";import{i as p,n as m,r as h,t as g}from"./linkConfigConfig-Dmhqv2K5.js";function _(e,t,i,a,c,u){let{account:p,poll:h,card:_}=e,v=n=>f(`span.contents`,a=>{i(i=>{d(a,function*(){let a=i?.[n]??{};for(let i in a)if(a[i]){let a=g[i];yield r(`icon-link`,a.urlFunctions[n](t,e),f(`img.link-icon`,{src:a.icon}),{title:`Go to ${m[n].toLowerCase()} on ${a.name}`})}})})}),y;return f(`div`,{className:`toot visibility-${e.visibility}`},f(`div.toot-head`,u,y=a&&f(`button.close-open`,{"@click":a}),v(`status`),f(`span.visibility`,`[${e.visibility}]`),e.edited_at?[f(`span.toot-created.line-through`,l(e.created_at)),f(`span.toot-edited`,l(e.edited_at))]:f(`span.toot-created`,l(e.created_at)),f(`img.toot-author-avatar`,{src:p.avatar_static}),f(`span.toot-author`,s(p.display_name,p.emojis)),f(`span.toot-acct`,`@`+p.acct),v(`profile`)),()=>{let t=f(`div.toot-body`,f(`div.toot-content`,n(e.content),o(e.emojis)),e.media_attachments?.length?()=>{let t=f(`ul.attachments`,e.media_attachments.map(e=>f(`li.attachment`,f(`img.preview`,{src:e.preview_url,title:e.description??void 0}),e.url&&r(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?f(`details.sensitive`,f(`summary`),t):t}:void 0,h&&f(`div.poll`,f(`ul.poll`,h.options.map((e,t)=>f(`li.poll-option`,f(`span.poll-option-title`,(h.own_votes??[]).includes(t)?h.multiple?`☑`:`⦿︎`:h.multiple?`☐`:`⚪︎`,` `,e.title),f(`span.poll-option-votes`,e.votes_count?.toString(),`/`,h.voters_count?.toString())))),h.voters_count===h.votes_count?null:f(`div.poll-votes-count`,`total votes: `,h.votes_count.toString()),f(`div.poll-expiry`,e=>e.classList.add(h.expired?`poll-expired`:`poll-ongoing`),h.expires_at&&l(h.expires_at))),_&&f(`div.card`,r(`card-title`,_.url,_.title),_.description&&f(`div.card-description`,_.description),_.image?f(`img.card-image`,{src:_.image,alt:_.image_description??void 0}):_.html?f(`div.card-html`,{innerHTML:_.html}):void 0));return e.spoiler_text&&(t=f(`details`,f(`summary`,e.spoiler_text),t)),t.classList.add(`toot-full-body`),c?c(e=>{y.textContent=e?`+`:`−`,y.title=e?`Open toot`:`Close toot`,t.hidden=e}):t.hidden=!0,t})}var v=new URLSearchParams(location.hash.substring(1));try{let t=v.get(`url`);if(t){let[n,r]=i(t)??y();v.delete(`url`),v.set(`instance`,n),v.set(`id`,r),window.history.replaceState({},``,`#`+v),await(await e).get(`treeOverview`,`${n}/${r}`)||c(n,r)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function y(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var b=`${v.get(`instance`)}/${v.get(`id`)}`;u(`followToots`,{async updatedTreeOverview(e){e===b&&G(!1)},async updatedTree(e){e===b&&G(!0)},async deletedTree(e){e===b&&G(!0)},cleared(){G(!0)}});var x=await e,S=p();async function C(){S.value=(await x.get(`treeOverview`,b))?.closedIds}var w=document.querySelector(`#app`),T=document.querySelector(`#ancestors`),E=document.querySelector(`#descendants`),D=e=>e.edited_at?`${e.id}@${e.edited_at}`:e.id;async function O(){let e=await x.get(`treeOverview`,b);e&&(e.closedIds.clear(),a(e))}async function k(){let e=await x.get(`treeOverview`,b);if(!e)return;let t=await x.get(`treeDetails`,b);if(!t)return;let{root:n,descendants:r}=t,{closedIds:i}=e;[n,...r].forEach(e=>i.add(D(e))),a(e)}var A=(e,t)=>async()=>{let n=await x.get(`treeOverview`,t);if(!n)return;let{closedIds:r}=n;r.has(e)?r.delete(e):r.add(e),a(n)},j=e=>t=>{h(()=>{t(S.value?.has(e)??!1)})},M=p();async function N(){M.value=(await x.get(`config`,`links`)).value}var P=e=>{h(()=>{e(M.value)})};new BroadcastChannel(`linkConfig`).addEventListener(`message`,N),N();function F(e){if(e)return f(`li.children-mismatch`,`Mismatch: Found ${Math.abs(e)} ${Math.abs(e)===1?`child`:`children`} ${e<0?`less`:`more`} than expected.`)}function I(e){let{key:t,tootTree:n}=e;function*r({toot:e,children:n},i=0){let a=n.find(t=>t.toot.account.id===e.account.id),o=i+1,s=i>0||a?f(`span.thread-pos`,`#${o}`):void 0,[c]=t.split(`/`,1);yield _(e,c,P,A(D(e),t),j(D(e)),s),yield f(`ul.tree-node`,n.map(e=>e===a?null:f(`li`,r(e))),F(n.length-e.replies_count)),a&&(yield*r(a,o))}d(E,r(n))}function L(e,t){let{key:n,root:r,descendants:i}=e,[a]=n.split(`/`,1);d(E,f(`ul.toot-list`,[r,...t?i.filter(e=>!S.value?.has(D(e))):i].map(e=>f(`li`,_(e,a,P,A(D(e),n),j(D(e)))))))}var R=[`hierarchical`,`chronological`,`root + open`],z=p(`hierarchical`),B=`Possible reasons for a mismatch between expected and actual number of toots:
- Without authentication Mastodon reports at most 60 descendants.
- Some toots might be non-public.
- Replies or reply counts might not yet be propagated to your instance.
- ...`;function V(e,n,r){let{rootAuthor:i,rootAccountEmojis:a}=e;d(w,f(`div.tree-head-author`,f(`img.tree-head-avatar`,{src:e.rootAuthorAvatar}),f(`span.tree-head-name`,i?s(i,a):b),f(`span.tree-head-acct`,e.rootAcct?`@${e.rootAcct} on ${n}`:``)),f(`span.tree-head-date`,l(e.rootCreatedAt),` – `,l(e.lastCreatedAt),`\u2003last fetched ${l(e.lastRetrievalDate)}`),f(`span.tree-head-statistics`,f(`span`,`${1+(e.nDescendants??0)} toot(s)`),e.nDescendants===e.nExpectedDescendants?``:f(`span.warn`,{title:B},`${(e.nExpectedDescendants??0)+1} expected`),f(`span`,`${e.nOpen??`??`} open`)),f(`div.tree-head-buttons`,f(`button`,{textContent:`[−] Close all`,"@click":()=>k()}),f(`button`,{textContent:`[+] Open all`,"@click":()=>O()}),f(`button`,{textContent:`⟳ Reload`,"@click":()=>c(n,r)}),f(`button`,{textContent:`✗ Remove`,"@click":()=>e&&t(e)})),f(`div.tree-head-choose-mode`,R.map(e=>f(`label`,f(`input`,{type:`radio`,"@click":()=>{z.value=e}},t=>{h(()=>{t.checked=e===z.value})}),e))))}function H(e,t){d(w,f(`div`,`You are currently not following toot ${t} from ${e}. `),f(`div`,f(`button`,{textContent:`Follow`,"@click":()=>c(e,t)}),` it or close this tab.`)),T.replaceChildren(),E.replaceChildren()}function U(e){let t=e.ancestors;if(t.length===0){T.replaceChildren();return}let n=t[0],[r]=b.split(`/`,1);d(T,f(`div.root-ancestor`,_(n,r,P),f(`div.more-ancestors`,t.length===1?`↓`:`↓\u2003${t.length-1} more ancestor toot(s)`)))}async function W(e){U(e),h(()=>{switch(z.value){case`hierarchical`:I(e);break;case`chronological`:L(e,!1);break;case`root + open`:L(e,!0);break;default:E.replaceChildren(`Oops`)}})}async function G(e){await C();let[t,n]=b.split(`/`),r=await x.get(`treeOverview`,b);if(!r){H(t,n);return}if(document.title=`${r.rootAuthor}: "${r.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=r.rootAuthorAvatar??``,V(r,t,n),e){let e=await x.get(`treeDetails`,b);if(!e){document.title=r.rootAuthor??`Follow Toot`;return}await W(e)}}G(!0);