import"./nav-Dzs_oev3.js";import{t as e}from"./database-BGZyZyq9.js";import{a as t,d as n,f as r,i,l as a,m as o,n as ee,p as s,r as c,s as l,t as u,u as d}from"./formatDate-K6im5yFx.js";import{a as f,n as p,o as m,r as h,t as te}from"./signals-core.module-PplyFw7G.js";import{n as ne,r as re,t as ie}from"./linkConfigConfig-YtmXU9nm.js";var ae=`.context-menu {\r
  position: fixed;\r
  width: max-content;\r
  z-index: 1000;\r
  display: none;\r
  list-style: none;\r
  border-radius: 3px;\r
  border: 1px solid #444;\r
  padding: 2px;\r
  background-color: #ccc;\r
  &.open {\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,g=new CSSStyleSheet;g.replaceSync(ae);var _=class e extends HTMLElement{static disabled=!1;static current;open;close;itemProvider;constructor(){super();let t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(g);let n=h(`div.context-menu`,h(`slot`));n.setAttribute(`tabindex`,`0`),t.append(n),this.open=t=>{e.current?.close(),e.current=this,!e.disabled&&(f(this,this.itemProvider?.()),t.preventDefault(),n.classList.add(`open`),o(n.style,{left:(t.clientX+n.offsetWidth<=window.innerWidth?t.clientX:t.clientX>=n.offsetWidth?t.clientX-n.offsetWidth:Math.max(0,window.innerWidth-n.offsetWidth))+`px`,top:(t.clientY+n.offsetHeight<=window.innerHeight?t.clientY:t.clientY>=n.offsetHeight?t.clientY-n.offsetHeight:Math.max(0,window.innerHeight-n.offsetHeight))+`px`}),n.focus(),n.onkeydown=e=>{e.key===`Escape`&&this.close()},document.addEventListener(`click`,this.close))},this.close=()=>{e.current=void 0,this.replaceChildren(),n.classList.remove(`open`),document.removeEventListener(`click`,this.close),document.removeEventListener(`contextmenu`,this.close)}}connectedCallback(){this.parentElement.addEventListener(`contextmenu`,this.open)}disconnectedCallback(){this.close(),this.parentElement.removeEventListener(`contextmenu`,this.open)}};window.customElements.define(`context-menu`,_);var oe=`.menu {\r
  position: relative;\r
  display: inline-block;\r
  > summary {\r
    padding-inline: 3px;\r
    border-radius: 3px;\r
    cursor: default;\r
    &::marker {\r
      content: "";\r
    }\r
    &:hover {\r
      background-color: #0003;\r
    }\r
  }\r
  > .items {\r
    position: absolute;\r
    top: 100%;\r
    z-index: 1;\r
\r
    border: 1px solid #444;\r
    border-radius: 3px;\r
    padding: 2px;\r
    width: max-content;\r
    background-color: #ccc;\r
\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,v=new CSSStyleSheet;v.replaceSync(oe);var y=class extends HTMLElement{close;itemProvider;constructor(){super();let e=h(`details.menu`,{onkeydown:t=>{t.key===`Escape`&&(e.open=!1)},ontoggle:()=>f(this,e.open?this.itemProvider?.():null)},h(`summary`,`☰`),h(`div.items`,h(`slot`))),t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(v),t.append(e),this.close=t=>{e.open&&(e.open=!1,t.preventDefault())}}connectedCallback(){document.addEventListener(`click`,this.close)}disconnectedCallback(){document.removeEventListener(`click`,this.close)}};window.customElements.define(`drop-down-menu`,y);var b=class extends HTMLElement{#e=h(`span.contents.prefix`);#t=h(`input.seen`,{type:`checkbox`,onchange:()=>this.seen=this.seen,title:`Mark toot as seen/unseen`});#n;#r=new y;#i=new _;set headerPrefix(e){f(this.#e,e)}get seen(){return this.#t.checked}set seen(e){this.#t.checked=e,this.onseenchange?.(new CustomEvent(`seenchanged`,{detail:this.seen}))}onseenchange;set dropDownMenuItemProvider(e){this.#r.itemProvider=()=>e(this.#n,this)}set contextMenuItemProvider(e){this.#i.itemProvider=()=>e(this.#n,this)}constructor(e){super(),this.#n=e;let{account:t,poll:n,card:i}=e;f(this,{className:`toot visibility-${e.visibility}`,tabIndex:0},this.#i,h(`div.toot-head`,this.#e,this.#t,this.#r,h(`img.toot-author-avatar`,{src:t.avatar_static}),h(`span.toot-author`,c(t.display_name,t.emojis)),h(`span.toot-acct`,`@`+t.acct),h(`span.fill`,h(`span.visibility`,e.visibility),e.edited_at?[h(`span.toot-created.line-through`,u(e.created_at)),h(`span.toot-edited`,u(e.edited_at))]:h(`span.toot-created`,u(e.created_at)))),()=>{let t=h(`div.toot-body`,h(`div.toot-content`,r(e.content),ee(e.emojis)),e.media_attachments?.length?()=>{let t=h(`ul.attachments`,e.media_attachments.map(e=>h(`li.attachment`,h(`img.preview`,{src:e.preview_url,alt:e.description??``,title:e.description??``}),e.url&&s(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?h(`details.sensitive`,h(`summary`),t):t}:void 0,n&&h(`div.poll`,h(`ul.poll`,n.options.map((e,t)=>h(`li.poll-option`,h(`span.poll-option-title`,(n.own_votes??[]).includes(t)?n.multiple?`☑`:`⦿︎`:n.multiple?`☐`:`⚪︎`,` `,e.title),h(`span.poll-option-votes`,e.votes_count?.toString(),`/`,n.voters_count?.toString())))),n.voters_count===n.votes_count?null:h(`div.poll-votes-count`,`total votes: `,n.votes_count.toString()),h(`div.poll-expiry`,e=>e.classList.add(n.expired?`poll-expired`:`poll-ongoing`),n.expires_at&&u(n.expires_at))),i&&h(`div.card`,i.image?h(`img.card-image`,{src:i.image,alt:i.image_description??``,title:i.image_description??``,width:i.width??void 0,height:i.height??void 0}):void 0,function*(){i.provider_name&&(yield i.provider_url?s(`card-provider`,i.provider_url,i.provider_name):i.provider_name),yield s(`card-title`,i.url,i.title);let e=(i.authors??[]).filter(e=>e.name);switch(e.length){case 0:i.author_name&&(yield h(`span`,`by `,i.author_url?s(`card-author`,i.author_url,i.author_name):i.author_name));break;case 1:{let{name:t,url:n}=e[0];yield h(`span`,`by `,s(`card-author`,n,t));break}default:yield`by`,yield h(`ul.card-authors`,function*(){for(let{name:t,url:n}of e)yield h(`li`,s(`card-author`,n,t))});break}i.description&&h(`div.card-description`,i.description)}));return e.spoiler_text&&(t=h(`details`,h(`summary`,e.spoiler_text),t)),t.classList.add(`toot-full-body`),t})}};window.customElements.define(`rendered-toot`,b);function x(e,t,n){let r=e instanceof Array?e:[...e],i=r.length,a=r.findIndex(e=>e===t),o=a;do{o=(o+1)%i;let e=r[o];if(n(e))return e}while(o!==a)}function se(e,t,n){return x([...e].reverse(),t,n)}var ce=class{disposers=[];register(e){this.disposers.push(e)}disposeAll(){for(let e of this.disposers)e();this.disposers.length=0}};const S=(e,t,n)=>h(`button.menu-entry-with-key-hint`,h(`span`,e),h(`span`,t.map((e,t)=>[t===0?null:` + `,h(`span.keyboard`,e)])),{onclick:n});var C=new ce;function w(e){C.register(te(e))}var T=await e,E=new URLSearchParams(location.hash.substring(1));try{let e=E.get(`url`);if(e){let[t,n]=i(e)??le();E.delete(`url`),E.set(`instance`,t),E.set(`id`,n),window.history.replaceState({},``,`#`+E),await T.get(`treeOverview`,`${t}/${n}`)||l(t,n)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function le(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var D=E.get(`instance`),O=E.get(`id`),k=`${D}/${O}`;n(`followToots`,{async updatedTreeOverview(e){e===k&&$(!1)},async updatedTree(e){e===k&&$(!0)},async deletedTree(e){e===k&&$(!0)},cleared(){$(!0)}});var A,j,M=[],N=new Map;async function ue(){A&&a({...A,seenIds:new Set})}async function de(){A&&j&&a({...A,seenIds:new Set(M.map(e=>d(e)))})}var P=p(void 0,{name:`linkConfig`});async function F(){P.value=(await T.get(`config`,`links`)).value}new BroadcastChannel(`linkConfig`).addEventListener(`message`,F),F();var I=document.querySelector(`#context-menu`);{function e(){_.disabled=!I.checked}I.onchange=e,e()}var L=new Map,R=[];function z(e,t){R.push(e);let n=L.get(e);return n.headerPrefix=t,n}function B(e){if(!e)return;let t=L.get(e);t&&(t.focus({preventScroll:!0}),t.scrollIntoView({block:`center`,behavior:`smooth`}))}function V(e){let t=R.findIndex(t=>t===e);t<0||B(R[(t+1)%R.length])}function H(e){let t=R.length,n=R.findIndex(t=>t===e);n<0||B(R[(n-1+t)%t])}function U(e){B(x(R,e,e=>!N.get(d(e))?.value))}function W(e){B(se(R,e,e=>!N.get(d(e))?.value))}var G=(e,t)=>{let n=N.get(d(e)),r=n.value,i=P.value;return[S(r?`☐ Mark toot as unseen`:`☑ Mark toot as seen`,[`Space`],()=>{n.value=!r,setTimeout(()=>{t.scrollIntoView({block:`center`,behavior:`smooth`}),t.focus()},100)}),S(`Previous unseen toot`,[`Ctrl`,`⬅`],()=>W(e)),S(`Previous toot`,[`⬅`],()=>H(e)),S(`Next toot`,[`➡`],()=>V(e)),S(`Next unseen toot`,[`Ctrl`,`➡`],()=>U(e)),function*(){for(let t of ne){let n=i[t];for(let r in n)if(n[r]){let n=ie[r],i=n.urlFunctions[t](D,e);yield h(`button.open-link`,{onclick:()=>window.open(i)},h(`img.link-icon`,{src:n.icon}),` Open ${re[t].toLowerCase()} on ${n.name(D)}`)}}},h(`button.follow-toot`,{onclick:()=>{let t=new URL(`./tree.html`,document.location.href);t.hash=new URLSearchParams({url:`https://${D}/@${e.account.acct}/${e.id}`}).toString(),window.open(t)}},`Follow toot`)]},fe=(e,t)=>n=>{if(!(n.shiftKey||n.altKey||n.metaKey)){switch(n.key){case`ArrowRight`:n.ctrlKey?U(e):V(e);break;case`ArrowLeft`:n.ctrlKey?W(e):H(e);break;case` `:t.value=!t.value;break;default:return}n.preventDefault(),n.stopImmediatePropagation()}},K=document.querySelector(`#toot-tree`),q=document.querySelector(`#ancestors`),J=document.querySelector(`#descendants`);function pe(e,t){let n=e.findIndex(t);return n<0?{rest:e}:{found:e[n],rest:e.toSpliced(n,1)}}function Y(e){let t=e.toot.account.id,n=[];for(let r=e;r;){let{found:e,rest:i}=pe(r.children,e=>e.toot.account.id===t);n.push({toot:r.toot,children:i.map(Y)}),r=e}return n}function me(){let{root:e,descendants:t}=j,n=new Map([e,...t].map(e=>[e.id,{toot:e,children:[]}]));for(let r of t){let{in_reply_to_id:t,in_reply_to_account_id:i}=r;if(!t){console.error(`descendant without uplink:`,r);continue}if(!n.has(t)){let r={toot:{is_missing:!0,id:t,in_reply_to_id:e.id,account:{id:i}},children:[]};n.get(e.id).children.push(r),n.set(t,r)}n.get(t).children.push(n.get(r.id))}let r=Y(n.get(e.id));function*i(e){let t=0;for(let{toot:n,children:r}of e)yield h(`div.node`,`is_missing`in n?he():z(n,e.length===1?void 0:h(`span.thread-pos`,`${++t}/${e.length}`)),function*(){r.length>0&&(yield h(`ul`,function*(){for(let e of r)yield h(`li`,i(e))}))})}J.classList.add(`tree-root`),J.classList.add(`chrono`),f(J,i(r))}var he=()=>h(`div.missing-toot`,`toot(s) missing/deleted/inaccessible`);function ge(){let{root:e,descendants:t}=j;f(J,[e,...t].map(e=>h(`div.node`,z(e))))}var X=p(!0,{name:`display-tree`});function Z(e,...t){m(document.querySelector(e),...t)}function Q(e,...t){f(document.querySelector(e),...t)}function _e(){if(!A)return;let{rootAuthor:e,rootAccountEmojis:n,rootAuthorAvatar:r,rootAcct:i,rootCreatedAt:a,lastCreatedAt:o,lastRetrievalDate:ee,nToots:s,nUnseen:d}=A;Q(`#tree-head-name`,e?c(e,n):k),Z(`#tree-head-avatar`,{src:r}),Q(`#tree-head-acct`,i?`@${i} on ${D}`:``),Q(`#tree-head-date-from`,u(a)),Q(`#tree-head-date-to`,u(o)),Q(`#tree-head-date-fetched`,u(ee)),Q(`#n-toots`,s?.toFixed()??`??`),Q(`#n-unseen`,d?.toFixed()??`??`),Z(`#all-seen`,{onclick:()=>de()}),Z(`#all-unseen`,{onclick:()=>ue()}),Z(`#reload`,{onclick:()=>l(D,O)}),Z(`#remove`,{onclick:()=>t(A)}),Z(`#display-tree`,{onchange:e=>X.value=e.currentTarget.checked})}function ve(){Q(`#toot-id`,O),Q(`#toot-instance`,D),Z(`#follow`,{onclick:()=>l(D,O)}),q.replaceChildren(),J.replaceChildren()}function ye(){w(()=>{f(q,j.ancestors.map((e,t,n)=>[h(`div.node`,z(e)),X.value&&(n.at(t+1)??j.root).in_reply_to_id!==e.id?h(`div.node`,he()):void 0]))})}async function be(){let e=new Map;for(let t of M){let n=e.get(t.account.acct);n?n.n++:e.set(t.account.acct,{n:1,account:t.account})}let t=[...e.values()];t.sort((e,t)=>t.n-e.n),Q(`#n-users`,t.length.toString()),Q(`#user-stats`,t.map(({n:e,account:t})=>h(`span`,h(`img`,{src:t.avatar_static,title:`${t.display_name} @${t.acct}`}),e>1?e.toString():null))),C.disposeAll(),N.clear();for(let e of M){let t=d(e),n=p(A?.seenIds.has(t)??!1);w(()=>{let e=n.value??!1;if(!A)return;let{seenIds:r}=A;r.has(t)!==e&&(e?r.add(t):r.delete(t),a(A))}),N.set(t,n)}L.clear();for(let e of M){let t=N.get(d(e)),n=m(new b(e),{contextMenuItemProvider:G,dropDownMenuItemProvider:G,onseenchange:e=>t.value=e.detail,onkeydown:fe(e,t),ondblclick:()=>t.value=!t.value});w(()=>{n.seen=t.value}),L.set(e,n)}R.length=0,ye(),w(()=>{R.length=j.ancestors.length,X.value?(K.classList.add(`tree`),me()):(K.classList.remove(`tree`),ge())}),B(j?.root)}async function $(e){if(A=await T.get(`treeOverview`,k),Z(`#app`,{hidden:!A}),Z(`#not-following`,{hidden:!!A}),!A){ve();return}if(document.title=`${A.rootAuthor}: "${A.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=A.rootAuthorAvatar??``,_e(),e){if(j=await T.get(`treeDetails`,k),!j){document.title=A.rootAuthor??`Follow Toot`;return}let{ancestors:e,root:t,descendants:n}=j;M=[...e,t,...n],await be()}else{if(!j)return;let{seenIds:e}=A;for(let t of M){let n=d(t),r=N.get(n);r?r.value=e.has(n):console.warn(`Misssing "seen" signal for toot ${n}`)}}}$(!0);