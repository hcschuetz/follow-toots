import"./nav-CZS_fpMP.js";import{t as e}from"./database-BGZyZyq9.js";import{a as t,d as n,f as r,i,l as a,n as o,r as s,s as c,t as l,u}from"./formatDate-Dyo-rJ98.js";import{a as d,i as f,n as p,o as m,r as h,t as ee}from"./signals-core.module-PplyFw7G.js";import{n as te,r as ne,t as re}from"./linkConfigConfig-YtmXU9nm.js";var g=(e,t,...n)=>h(`a`,{href:t,target:`_blank`,rel:`noopener noreferrer`},t=>e.split(/[ \.]/).forEach(e=>e&&t.classList.add(e)),...n),ie={},_=(e={})=>({keep:!0,attributes:new Map(Object.entries({...ie,...e}))}),ae=new Map(Object.entries({DIV:_(),SPAN:_({translate:!1,class:!0}),P:_(),BR:_(),I:_(),B:_(),U:_(),STRONG:_(),EM:_(),UL:_(),OL:_(),LI:_(),CODE:_(),PRE:_()}));function*oe(e,t){for(let n of e.attributes)switch(t.get(n.name)){case void 0:console.warn(`skipping attribute`,n);break;case!0:yield n;break;case!1:break}}function*v(e){for(let t of e)if(t instanceof Text)yield t.textContent;else if(t instanceof HTMLAnchorElement)yield g(``,t.href,v(t.childNodes));else if(t instanceof HTMLElement){let e=ae.get(t.tagName);switch(e?.keep){case void 0:console.warn(`unknown element`,t),yield*v(t.childNodes);break;case!0:yield f(t.tagName,oe(t,e.attributes),v(t.childNodes));break;case!1:break}}else console.warn(`skipping node`,t)}var se=new DOMParser;function*ce(e){try{yield*v(se.parseFromString(e,`text/html`).body.childNodes)}catch{yield h(`div.sanitization-error`,`[Error sanitizing "${e}"`)}}var le=`.context-menu {\r
  position: fixed;\r
  width: max-content;\r
  z-index: 1000;\r
  display: none;\r
  list-style: none;\r
  border-radius: 3px;\r
  border: 1px solid #444;\r
  padding: 2px;\r
  background-color: #ccc;\r
  &.open {\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,ue=new CSSStyleSheet;ue.replaceSync(le);var y=class e extends HTMLElement{static current;open;close;itemProvider;constructor(){super();let t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(ue);let n=h(`div.context-menu`,h(`slot`));n.setAttribute(`tabindex`,`0`),t.append(n),this.open=t=>{t.ctrlKey&&(e.current?.close(),e.current=this,d(this,this.itemProvider?.()),t.preventDefault(),n.classList.add(`open`),r(n.style,{left:(t.clientX+n.offsetWidth<=window.innerWidth?t.clientX:t.clientX>=n.offsetWidth?t.clientX-n.offsetWidth:Math.max(0,window.innerWidth-n.offsetWidth))+`px`,top:(t.clientY+n.offsetHeight<=window.innerHeight?t.clientY:t.clientY>=n.offsetHeight?t.clientY-n.offsetHeight:Math.max(0,window.innerHeight-n.offsetHeight))+`px`}),n.focus(),n.onkeydown=e=>{e.key===`Escape`&&this.close()},document.addEventListener(`click`,this.close))},this.close=()=>{e.current=void 0,this.replaceChildren(),n.classList.remove(`open`),document.removeEventListener(`click`,this.close),document.removeEventListener(`contextmenu`,this.close)}}connectedCallback(){this.parentElement.addEventListener(`contextmenu`,this.open)}disconnectedCallback(){this.close(),this.parentElement.removeEventListener(`contextmenu`,this.open)}};window.customElements.define(`context-menu`,y);var de=`.menu {\r
  position: relative;\r
  display: inline-block;\r
  > summary {\r
    padding-inline: 3px;\r
    border-radius: 3px;\r
    cursor: default;\r
    &::marker {\r
      content: "";\r
    }\r
    &:hover {\r
      background-color: #0003;\r
    }\r
  }\r
  &:open::details-content {\r
    position: absolute;\r
    top: 100%;\r
    z-index: 1;\r
\r
    border: 1px solid #444;\r
    border-radius: 3px;\r
    padding: 2px;\r
    width: max-content;\r
    background-color: #ccc;\r
\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,fe=new CSSStyleSheet;fe.replaceSync(de);var pe=class extends HTMLElement{close;itemProvider;constructor(){super();let e=h(`details.menu`,{onkeydown:t=>{t.key===`Escape`&&(e.open=!1)},ontoggle:()=>this.itemProvider&&d(this,e.open?this.itemProvider?.():null)},h(`summary`,`☰`),h(`slot`)),t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(fe),t.append(e),this.close=t=>{e.open&&(e.open=!1,t.target===this&&t.preventDefault())}}connectedCallback(){document.addEventListener(`click`,this.close)}disconnectedCallback(){document.removeEventListener(`click`,this.close)}};window.customElements.define(`drop-down-menu`,pe);var me=`modulepreload`,he=function(e,t){return new URL(e,t).href},ge={};const _e=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let e=document.getElementsByTagName(`link`),i=document.querySelector(`meta[property=csp-nonce]`),a=i?.nonce||i?.getAttribute(`nonce`);function o(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:`fulfilled`,value:e}),e=>({status:`rejected`,reason:e}))))}r=o(t.map(t=>{if(t=he(t,n),t in ge)return;ge[t]=!0;let r=t.endsWith(`.css`),i=r?`[rel="stylesheet"]`:``;if(n)for(let n=e.length-1;n>=0;n--){let i=e[n];if(i.href===t&&(!r||i.rel===`stylesheet`))return}else if(document.querySelector(`link[href="${t}"]${i}`))return;let o=document.createElement(`link`);if(o.rel=r?`stylesheet`:me,r||(o.as=`script`),o.crossOrigin=``,o.href=t,a&&o.setAttribute(`nonce`,a),document.head.appendChild(o),r)return new Promise((e,n)=>{o.addEventListener(`load`,e),o.addEventListener(`error`,()=>n(Error(`Unable to preload CSS for ${t}`)))})}))}function i(e){let t=new Event(`vite:preloadError`,{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(let e of t||[])e.status===`rejected`&&i(e.reason);return e().catch(i)})};var ve=`https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/`,b;function ye(){if(!b){b=new CSSStyleSheet;let e=ve+`katex.min.css`;(async()=>{try{await b.replace(await(await fetch(e)).text())}catch(e){console.error(e),alert(`Exception while getting/applying KaTeX stylesheet:
`+e)}})(),document.head.appendChild(h(`link`,{rel:`stylesheet`,href:e}))}return b}async function be(e){try{let t=(await _e(async()=>{let{default:e}=await import(ve+`contrib/auto-render.min.mjs`);return{default:e}},[],import.meta.url)).default,n=x(e);t(n);let r=S(n);e.replaceChildren(...r.childNodes)}catch(e){console.error(e),alert(`LaTeX rendering failed:
`+e)}}var xe=/\$\$(?:.|\n)+\$\$|\$[^$]+\$|\\\((?:.|\n)+\\\)|\\\[(?:.|\n)+\\\]/;function Se(e){let t=e=>[...e.childNodes].some(e=>e instanceof Text&&xe.test(e.data)||e instanceof Element&&Se(e)),n=x(e);return n.normalize(),t(n)}const Ce=()=>h(`span`,{style:`
      font-family: Times New Roman, serif;
    `},`L`,h(`span`,{style:`
      font-size: 0.85em;
      vertical-align: 0.15em;
      margin-left: -0.36em;
      margin-right: -0.15em;    
    `},`A`),`T`,h(`span`,{style:`
      vertical-align: -0.5ex;
      margin-left: -0.1667em;
      margin-right: -0.125em;    
    `},`E`),`X`);function x(e){let t=e.cloneNode();return t.append(...[...e.childNodes].map(e=>e instanceof HTMLBRElement?`
`:e instanceof Element?x(e):e instanceof Text?e.data:``)),t}function S(e){let t=e.cloneNode();return t.append(...[...e.childNodes].flatMap(e=>e instanceof Text?e.data.split(`
`).flatMap((e,t)=>t==0?[e]:[h(`br`),e]):e instanceof Element?[S(e)]:[])),t}var we=`.toot-content {\r
  white-space: pre-wrap;\r
}\r
\r
p {\r
  margin-block: 0.3em;\r
  &:first-child {\r
    margin-top: 0;\r
  }\r
  &:last-child {\r
    margin-bottom: 0;\r
  }\r
}\r
\r
/* TODO make these hacks configurable?: */\r
span.ellipsis::after {\r
  content: "...";\r
}\r
span.invisible {\r
  display: inline-block;\r
  width: 0;\r
  text-wrap-mode: nowrap;\r
  overflow-x: hidden;\r
}\r
\r
.custom-emoji {\r
  position: relative;\r
  bottom: -0.12lh;\r
  height: .7lh;\r
}\r
`,C=[[`reblogs_count`,`B`,`boost`,`boosts`,`onshowboosts`],[`favourites_count`,`F`,`favourite`,`favourites`,`onshowfavs`],[`quotes_count`,`Q`,`quote`,`quotes`],[`replies_count`,`R`,`reply`,`replies`]].map(([e,t,n,r,i])=>({prop:e,abbr:t,singular:n,plural:r,method:i})),Te=new CSSStyleSheet;Te.replace(we);var Ee=class extends HTMLElement{#e;get head(){return this.#e}#t=h(`span.contents.prefix`);#n=h(`input.seen`,{type:`checkbox`,onchange:()=>this.seen=this.seen,title:`Mark toot as seen/unseen`});#r;#i=new pe;#a=new y;set headerPrefix(e){d(this.#t,e)}get seen(){return this.#n.checked}set seen(e){this.#n.checked=e,this.onseenchange?.(new CustomEvent(`seenchanged`,{detail:this.seen}))}onseenchange;onshowboosts;onshowfavs;set dropDownMenuItemProvider(e){this.#i.itemProvider=()=>[e(this.#r)]}set contextMenuItemProvider(e){this.#a.itemProvider=()=>[e(this.#r)]}constructor(e){super(),this.#r=e;let{account:t,poll:n,card:r}=e,i=h(`span.contents`),a=C.every(({prop:t})=>e[t]===0)?null:h(`span.toot-stats`,{title:C.map(({prop:t,singular:n,plural:r})=>{let i=e[t];return`${i} ${i===1?n:r}`}).join(`, `)},C.filter(({prop:t})=>e[t]!==0).flatMap(({prop:t,abbr:n,method:r},i)=>[...i===0?[]:[`/`],h(`span`,r&&{onclick:t=>{t.stopImmediatePropagation(),t.preventDefault(),this[r]?.(e)}},`${e[t]}${n}`)]));d(this,{className:`toot visibility-${e.visibility}`,tabIndex:0},this.#a,this.#e=h(`div.toot-head`,this.#t,this.#n,this.#i,h(`img.toot-author-avatar`,{src:t.avatar_static}),h(`span.toot-author`,s(t.display_name,t.emojis)),h(`span.toot-acct`,`@`+t.acct),h(`span.fill`,i,a,h(`span.visibility`,e.visibility),e.edited_at?[h(`span.toot-created.line-through`,l(e.created_at)),h(`span.toot-edited`,l(e.edited_at))]:h(`span.toot-created`,l(e.created_at)))),()=>{let t=h(`div.toot-content`,ce(e.content),o(e.emojis)),a=h(`div.toot-content-host`),s=a.attachShadow({mode:`open`});s.adoptedStyleSheets.push(Te),s.getRootNode().appendChild(t);let c=h(`div.toot-body`,a,e.media_attachments?.length?()=>{let t=h(`ul.attachments`,e.media_attachments.map(e=>h(`li.attachment`,h(`img.preview`,{src:e.preview_url,alt:e.description??``,title:e.description??``}),e.url&&g(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?h(`details.sensitive`,h(`summary`),t):t}:void 0,n&&h(`div.poll`,h(`ul.poll`,n.options.map((e,t)=>h(`li.poll-option`,h(`span.poll-option-title`,(n.own_votes??[]).includes(t)?n.multiple?`☑`:`⦿︎`:n.multiple?`☐`:`⚪︎`,` `,e.title),h(`span.poll-option-votes`,e.votes_count?.toString(),`/`,n.voters_count?.toString())))),n.voters_count===n.votes_count?null:h(`div.poll-votes-count`,`total votes: `,n.votes_count.toString()),h(`div.poll-expiry`,e=>e.classList.add(n.expired?`poll-expired`:`poll-ongoing`),n.expires_at&&l(n.expires_at))),r&&h(`div.card`,r.image?h(`img.card-image`,{src:r.image,alt:r.image_description??``,title:r.image_description??``,width:r.width??void 0,height:r.height??void 0}):void 0,function*(){r.provider_name&&(yield r.provider_url?g(`card-provider`,r.provider_url,r.provider_name):r.provider_name),yield g(`card-title`,r.url,r.title);let e=(r.authors??[]).filter(e=>e.name);switch(e.length){case 0:r.author_name&&(yield h(`span`,`by `,r.author_url?g(`card-author`,r.author_url,r.author_name):r.author_name));break;case 1:{let{name:t,url:n}=e[0];yield h(`span`,`by `,g(`card-author`,n,t));break}default:yield`by`,yield h(`ul.card-authors`,function*(){for(let{name:t,url:n}of e)yield h(`li`,g(`card-author`,n,t))});break}r.description&&h(`div.card-description`,r.description)}));if(Se(t)){let e;m(i,h(`label`,Ce(),h(`input`,n=>({type:`checkbox`,onkeydown:e=>{e.key===` `&&e.stopPropagation()},onchange:r=>{if(r.stopImmediatePropagation(),r.preventDefault(),n.checked){e=t.cloneNode(!0),be(t);let{adoptedStyleSheets:n}=a.shadowRoot,r=ye();n.includes(r)||n.push(r)}else d(t,e.childNodes)}}))))}return e.spoiler_text&&(c=h(`details`,h(`summary`,e.spoiler_text),c)),c.classList.add(`toot-full-body`),c})}};window.customElements.define(`rendered-toot`,Ee);function w(e,t,n){let r=e instanceof Array?e:[...e],i=r.length,a=r.findIndex(e=>e===t),o=a;do{o=(o+1)%i;let e=r[o];if(n(e))return e}while(o!==a)}function De(e,t,n){return w([...e].reverse(),t,n)}var Oe=class{disposers=[];register(e){this.disposers.push(e)}disposeAll(){for(let e of this.disposers)e();this.disposers.length=0}};const T=(e,t,n)=>h(`button.menu-entry-with-key-hint`,h(`span`,e),h(`span`,t.map((e,t)=>[t===0?null:` + `,h(`span.keyboard`,e)])),{onclick:n});var E=new Oe;function D(e){E.register(ee(e))}var O=await e,k=new URLSearchParams(location.hash.substring(1));try{let e=k.get(`url`);if(e){let[t,n]=i(e)??ke();k.delete(`url`),k.set(`instance`,t),k.set(`id`,n),window.history.replaceState({},``,`#`+k),await O.get(`treeOverview`,`${t}/${n}`)||c(t,n)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function ke(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var A=k.get(`instance`),j=k.get(`id`),M=`${A}/${j}`,N=k.get(`focus`);N||(N=j,k.set(`focus`,N),window.history.replaceState({},``,`#`+k)),n(`followToots`,{async updatedTreeOverview(e){e===M&&$(!1)},async updatedTree(e){e===M&&$(!0)},async deletedTree(e){e===M&&$(!0)},cleared(){$(!0)}});var P,F,I=[],L=new Map;async function Ae(){P&&a({...P,seenIds:new Set})}async function je(){P&&F&&a({...P,seenIds:new Set(I.map(e=>u(e)))})}var R=p(void 0,{name:`linkConfig`});async function z(){R.value=(await O.get(`config`,`links`)).value}new BroadcastChannel(`linkConfig`).addEventListener(`message`,z),z();var B=new Map,V=[];function H(e,t){V.push(e);let n=B.get(e.id);return n.headerPrefix=t,n}function U(e){if(!e)return;let t=`#`+new URLSearchParams({instance:A,id:j,focus:e});t===document.location.hash?W():document.location.hash=t}window.addEventListener(`hashchange`,W);function W(){if(k=new URLSearchParams(location.hash.substring(1)),N=k.get(`focus`),!N)return;let e=B.get(N);e&&(e.focus({preventScroll:!0}),setTimeout(()=>Q(e),300))}function G(e){let t=V.findIndex(t=>t===e);t<0||U(V[(t+1)%V.length]?.id)}function K(e){let t=V.length,n=V.findIndex(t=>t===e);n<0||U(V[(n-1+t)%t]?.id)}function Me(e){U(w(V,e,e=>!L.get(u(e))?.value)?.id)}function Ne(e){U(De(V,e,e=>!L.get(u(e))?.value)?.id)}var Pe=e=>{let t=L.get(u(e)),n=t.value,r=R.value;return[T(n?`☐ Mark toot as unseen`:`☑ Mark toot as seen`,[`Space`],()=>t.value=!n),T(`Previous unseen toot`,[`Ctrl`,`⬅`],()=>Ne(e)),T(`Previous toot`,[`⬅`],()=>K(e)),T(`Next toot`,[`➡`],()=>G(e)),T(`Next unseen toot`,[`Ctrl`,`➡`],()=>Me(e)),function*(){if(r)for(let t of te){let n=r[t];for(let r in n)if(n[r]){let n=re[r];yield g(`button open-link`,n.urlFunctions[t](A,e),h(`img.link-icon`,{src:n.icon}),` Open ${ne[t].toLowerCase()} on ${n.name(A)}`)}}},()=>{let{root:t}=F,n=new URL(document.location.href);return n.hash=new URLSearchParams({url:`https://${A}/@${t.account.acct}/${t.id}`,focus:e.id}).toString(),h(`button.link-here`,`Copy link`,{onclick:()=>window.navigator.clipboard.writeText(n.toString())})}]},Fe=(e,t)=>n=>{if(!(n.shiftKey||n.altKey||n.metaKey)){switch(n.key){case`ArrowRight`:n.ctrlKey?Me(e):G(e);break;case`ArrowLeft`:n.ctrlKey?Ne(e):K(e);break;case` `:{t.value=!t.value;let n=B.get(e.id);n&&Q(n);break}default:return}n.preventDefault(),n.stopImmediatePropagation()}},Ie=document.querySelector(`#toot-tree`),q=document.querySelector(`#ancestors`),J=document.querySelector(`#descendants`);function Le(e,t){let n=e.findIndex(t);return n<0?{rest:e}:{found:e[n],rest:e.toSpliced(n,1)}}function Re(e){let t=e.toot.account.id,n=[];for(let r=e;r;){let{found:e,rest:i}=Le(r.children,e=>e.toot.account.id===t);n.push({toot:r.toot,children:i.map(Re)}),r=e}return n}function ze(){let{root:e,descendants:t}=F,n=new Map([e,...t].map(e=>[e.id,{toot:e,children:[]}]));for(let r of t){let{in_reply_to_id:t,in_reply_to_account_id:i}=r;if(!t){console.error(`descendant without uplink:`,r);continue}if(!n.has(t)){let r={toot:{is_missing:!0,id:t,in_reply_to_id:e.id,account:{id:i}},children:[]};n.get(e.id).children.push(r),n.set(t,r)}n.get(t).children.push(n.get(r.id))}let r=Re(n.get(e.id));function*i(e){let t=0;for(let{toot:n,children:r}of e)yield h(`div.node`,`is_missing`in n?Be():H(n,e.length===1?void 0:h(`span.thread-pos`,`${++t}/${e.length}`)),function*(){r.length>0&&(yield h(`ul`,function*(){for(let e of r)yield h(`li`,i(e))}))})}J.classList.add(`tree-root`),J.classList.add(`chrono`),d(J,i(r))}var Be=()=>h(`div.missing-toot`,`toot(s) missing/deleted/inaccessible`);function Ve(){let{root:e,descendants:t}=F;d(J,[e,...t].map(e=>h(`div.node`,H(e))))}var Y=p(!0,{name:`display-tree`});function X(e,...t){m(document.querySelector(e),...t)}function Z(e,...t){d(document.querySelector(e),...t)}function He(){if(!P)return;let{rootAuthor:e,rootAccountEmojis:n,rootAuthorAvatar:r,rootAcct:i,rootCreatedAt:a,lastCreatedAt:o,lastRetrievalDate:u,nToots:d,nUnseen:f}=P;Z(`#tree-head-name`,e?s(e,n):M),X(`#tree-head-avatar`,{src:r}),Z(`#tree-head-acct`,i?`@${i} on ${A}`:``),Z(`#tree-head-date-from`,l(a)),Z(`#tree-head-date-to`,l(o)),Z(`#tree-head-date-fetched`,l(u)),Z(`#n-toots`,d?.toFixed()??`??`),Z(`#n-unseen`,f?.toFixed()??`??`),X(`#all-seen`,{onclick:()=>je()}),X(`#all-unseen`,{onclick:()=>Ae()}),X(`#reload`,{onclick:()=>c(A,j)}),X(`#unfollow`,{onclick:()=>t(P)}),X(`#display-tree`,{onchange:e=>Y.value=e.currentTarget.checked})}function Ue(){Z(`#toot-id`,j),Z(`#toot-instance`,A),X(`#follow`,{onclick:()=>c(A,j)}),q.replaceChildren(),J.replaceChildren()}function We(){D(()=>{d(q,F.ancestors.map((e,t,n)=>[h(`div.node`,H(e)),Y.value&&(n.at(t+1)??F.root).in_reply_to_id!==e.id?h(`div.node`,Be()):void 0]))})}var Ge=Object.entries({following:`you follow`,showing_reblogs:`you get boosts`,notifying:`you get notified about toots`,followed_by:`follows you`,blocking:`you block`,blocked_by:`blocks you`,muting:`you mute`,muting_notifications:`you mute notifications`,requested:`you request to follow`,requested_by:`requests to follow you`,domain_blocking:`you block the domain`,endorsed:`you endorse/feature`});function Ke({n:e,account:t,relationship:n}){let r=h(`span`,{slot:`label`},{title:`${t.display_name} @${t.acct}`},h(`img`,{src:t.avatar_static}),e>1?e.toString():null);if(n){let e=Ge.flatMap(([e,t])=>n[e]===!0?[`
- `+t]:[]).join(``),t=n.note?.trim();e&&(r.title+=e),t&&(r.title+=`

`+t),(e||t)&&r.classList.add(`indicate-relationship`)}return r}var qe=document.querySelector(`#account-list-dialog`),Je=document.querySelector(`#account-list-heading`),Ye=document.querySelector(`#account-list-grid`);async function Xe(e){let t={},n=await O.get(`accessTokens`,A);n&&(t.Authorization=`Bearer ${n.token}`);let r=await fetch(e,{headers:t});if(!r.ok)throw`HTTPS status: ${r.status} ${r.statusText}`;return await r.json()}var Ze=(e,t)=>async n=>{let r=await Xe(`https://${A}/api/v1/statuses/${n.id}/${t}`);Je.replaceChildren(e),Ye.replaceChildren(...r.flatMap(e=>[h(`img`,{src:e.avatar}),h(`span.reaction-author`,s(e.display_name||e.acct,e.emojis)),h(`span.reaction-acct`,`@`+e.acct)])),qe.showModal()};async function Qe(){let e=new Map;for(let t of I){let n=e.get(t.account.acct);n?n.n++:e.set(t.account.acct,{n:1,account:t.account})}let t=[...e.values()];try{let e=await Xe(`https://${A}/api/v1/accounts/relationships?${t.map(e=>`id[]=${encodeURIComponent(e.account.id)}`).join(`&`)}`),n=new Map(t.map(e=>[e.account.id,e]));for(let t of e){let e=n.get(t.id);if(!e){console.warn(`Unexpected: no stats for id "${t.id}"`);continue}e.relationship=t}}catch(e){console.warn(`When retrieving relationships:`,e)}t.sort((e,t)=>t.n-e.n),Z(`#n-users`,t.length.toString()),Z(`#user-stats`,t.map(Ke)),E.disposeAll(),L.clear();for(let e of I){let t=u(e),n=p(P?.seenIds.has(t)??!1);D(()=>{let e=n.value??!1;if(!P)return;let{seenIds:r}=P;r.has(t)!==e&&(e?r.add(t):r.delete(t),a(P))}),L.set(t,n)}B.clear();for(let e of I){let t=L.get(u(e)),n=m(new Ee(e),{contextMenuItemProvider:Pe,dropDownMenuItemProvider:Pe,onseenchange:e=>t.value=e.detail,onshowboosts:Ze(`Boosted By`,`reblogged_by`),onshowfavs:Ze(`Favorited By`,`favourited_by`),onkeydown:Fe(e,t),onfocus:()=>U(e.id)},e=>e.addEventListener(`dblclick`,e=>{e.preventDefault(),e.stopImmediatePropagation(),t.value=!t.value,Q(n)},!0));D(()=>{n.seen=t.value}),B.set(e.id,n)}V.length=0,We(),D(()=>{V.length=F.ancestors.length,Y.value?(Ie.classList.add(`tree`),ze()):(Ie.classList.remove(`tree`),Ve())})}function Q(e){e.head.scrollIntoView({block:`center`,behavior:`smooth`})}async function $(e){if(P=await O.get(`treeOverview`,M),X(`#app`,{hidden:!P}),X(`#not-following`,{hidden:!!P}),!P){Ue();return}if(document.title=`${P.rootAuthor}: "${P.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=P.rootAuthorAvatar??``,He(),e){if(F=await O.get(`treeDetails`,M),!F){document.title=P.rootAuthor??`Follow Toot`;return}let{ancestors:e,root:t,descendants:n}=F;I=[...e,t,...n],await Qe(),W()}else{if(!F)return;let{seenIds:e}=P;for(let t of I){let n=u(t),r=L.get(n);r?r.value=e.has(n):console.warn(`Misssing "seen" signal for toot ${n}`)}}}$(!0);for(let e of document.querySelectorAll(`.close-dialog`))e.addEventListener(`click`,()=>{e.closest(`dialog`).close()});