import"./nav-Dzs_oev3.js";import{t as e}from"./database-BGZyZyq9.js";import{a as t,d as n,f as r,i,l as a,m as o,n as ee,p as s,r as c,s as l,t as u,u as d}from"./formatDate-K6im5yFx.js";import{a as f,n as p,o as m,r as h,t as te}from"./signals-core.module-PplyFw7G.js";import{n as ne,r as re,t as ie}from"./linkConfigConfig-YtmXU9nm.js";var ae=`.context-menu {\r
  position: fixed;\r
  width: max-content;\r
  z-index: 1000;\r
  display: none;\r
  list-style: none;\r
  border-radius: 3px;\r
  border: 1px solid #444;\r
  padding: 2px;\r
  background-color: #ccc;\r
  &.open {\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,oe=new CSSStyleSheet;oe.replaceSync(ae);var g=class e extends HTMLElement{static disabled=!1;static current;open;close;itemProvider;constructor(){super();let t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(oe);let n=h(`div.context-menu`,h(`slot`));n.setAttribute(`tabindex`,`0`),t.append(n),this.open=t=>{e.current?.close(),e.current=this,!e.disabled&&(f(this,this.itemProvider?.()),t.preventDefault(),n.classList.add(`open`),o(n.style,{left:(t.clientX+n.offsetWidth<=window.innerWidth?t.clientX:t.clientX>=n.offsetWidth?t.clientX-n.offsetWidth:Math.max(0,window.innerWidth-n.offsetWidth))+`px`,top:(t.clientY+n.offsetHeight<=window.innerHeight?t.clientY:t.clientY>=n.offsetHeight?t.clientY-n.offsetHeight:Math.max(0,window.innerHeight-n.offsetHeight))+`px`}),n.focus(),n.onkeydown=e=>{e.key===`Escape`&&this.close()},document.addEventListener(`click`,this.close))},this.close=()=>{e.current=void 0,this.replaceChildren(),n.classList.remove(`open`),document.removeEventListener(`click`,this.close),document.removeEventListener(`contextmenu`,this.close)}}connectedCallback(){this.parentElement.addEventListener(`contextmenu`,this.open)}disconnectedCallback(){this.close(),this.parentElement.removeEventListener(`contextmenu`,this.open)}};window.customElements.define(`context-menu`,g);var se=`.menu {\r
  position: relative;\r
  display: inline-block;\r
  > summary {\r
    padding-inline: 3px;\r
    border-radius: 3px;\r
    cursor: default;\r
    &::marker {\r
      content: "";\r
    }\r
    &:hover {\r
      background-color: #0003;\r
    }\r
  }\r
  &:open::details-content {\r
    position: absolute;\r
    top: 100%;\r
    z-index: 1;\r
\r
    border: 1px solid #444;\r
    border-radius: 3px;\r
    padding: 2px;\r
    width: max-content;\r
    background-color: #ccc;\r
\r
    display: flex;\r
    flex-direction: column;\r
    gap: 2px;\r
  }\r
}\r
`,_=new CSSStyleSheet;_.replaceSync(se);var v=class extends HTMLElement{close;itemProvider;constructor(){super();let e=h(`details.menu`,{onkeydown:t=>{t.key===`Escape`&&(e.open=!1)},ontoggle:()=>f(this,e.open?this.itemProvider?.():null)},h(`summary`,`☰`),h(`slot`)),t=this.attachShadow({mode:`open`});t.adoptedStyleSheets.push(_),t.append(e),this.close=t=>{e.open&&(e.open=!1,t.preventDefault())}}connectedCallback(){document.addEventListener(`click`,this.close)}disconnectedCallback(){document.removeEventListener(`click`,this.close)}};window.customElements.define(`drop-down-menu`,v);var ce=`modulepreload`,le=function(e,t){return new URL(e,t).href},ue={};const de=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let e=document.getElementsByTagName(`link`),i=document.querySelector(`meta[property=csp-nonce]`),a=i?.nonce||i?.getAttribute(`nonce`);function o(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:`fulfilled`,value:e}),e=>({status:`rejected`,reason:e}))))}r=o(t.map(t=>{if(t=le(t,n),t in ue)return;ue[t]=!0;let r=t.endsWith(`.css`),i=r?`[rel="stylesheet"]`:``;if(n)for(let n=e.length-1;n>=0;n--){let i=e[n];if(i.href===t&&(!r||i.rel===`stylesheet`))return}else if(document.querySelector(`link[href="${t}"]${i}`))return;let o=document.createElement(`link`);if(o.rel=r?`stylesheet`:ce,r||(o.as=`script`),o.crossOrigin=``,o.href=t,a&&o.setAttribute(`nonce`,a),document.head.appendChild(o),r)return new Promise((e,n)=>{o.addEventListener(`load`,e),o.addEventListener(`error`,()=>n(Error(`Unable to preload CSS for ${t}`)))})}))}function i(e){let t=new Event(`vite:preloadError`,{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(let e of t||[])e.status===`rejected`&&i(e.reason);return e().catch(i)})};var fe=`https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/`,pe=h(`link`,{rel:`stylesheet`});document.head.append(pe);async function me(e){try{pe.href=fe+`katex.min.css`;let t=(await de(async()=>{let{default:e}=await import(fe+`contrib/auto-render.min.mjs`);return{default:e}},[],import.meta.url)).default,n=b(e);t(n);let r=_e(n);e.replaceChildren(...r.childNodes)}catch(e){console.error(e),alert(`LaTeX rendering failed:
`+e)}}var he=/\$\$(?:.|\n)+\$\$|\$[^$]+\$|\\\((?:.|\n)+\\\)|\\\[(?:.|\n)+\\\]/;function y(e){let t=e=>[...e.childNodes].some(e=>e instanceof Text&&he.test(e.data)||e instanceof Element&&y(e)),n=b(e);return n.normalize(),t(n)}const ge=()=>h(`span`,{style:`
      font-family: Times New Roman, serif;
    `},`L`,h(`span`,{style:`
      font-size: 0.85em;
      vertical-align: 0.15em;
      margin-left: -0.36em;
      margin-right: -0.15em;    
    `},`A`),`T`,h(`span`,{style:`
      vertical-align: -0.5ex;
      margin-left: -0.1667em;
      margin-right: -0.125em;    
    `},`E`),`X`);function b(e){let t=e.cloneNode();return t.append(...[...e.childNodes].map(e=>e instanceof HTMLBRElement?`
`:e instanceof Element?b(e):e instanceof Text?e.data:``)),t}function _e(e){let t=e.cloneNode();return t.append(...[...e.childNodes].flatMap(e=>e instanceof Text?e.data.split(`
`).flatMap((e,t)=>t==0?[e]:[h(`br`),e]):e instanceof Element?[_e(e)]:[])),t}var ve=[[`reblogs_count`,`B`],[`favourites_count`,`F`],[`quotes_count`,`Q`],[`replies_count`,`R`]],ye=`Number(s) of [B]oosts/[F]avourites/[Q]uotes/[R]eplies`;function be(e){let t=ve.flatMap(([t,n])=>{let r=e[t];return r?[`${r}${n}`]:[]}).join(`/`);return t?h(`span.toot-stats`,{title:ye},`[${t}]`):null}var x=class extends HTMLElement{#e=h(`span.contents.prefix`);#t=h(`input.seen`,{type:`checkbox`,onchange:()=>this.seen=this.seen,title:`Mark toot as seen/unseen`});#n;#r=new v;#i=new g;set headerPrefix(e){f(this.#e,e)}get seen(){return this.#t.checked}set seen(e){this.#t.checked=e,this.onseenchange?.(new CustomEvent(`seenchanged`,{detail:this.seen}))}onseenchange;set dropDownMenuItemProvider(e){this.#r.itemProvider=()=>[e(this.#n,this)]}set contextMenuItemProvider(e){this.#i.itemProvider=()=>[e(this.#n,this)]}constructor(e){super(),this.#n=e;let{account:t,poll:n,card:i}=e,a=h(`span.contents`);f(this,{className:`toot visibility-${e.visibility}`,tabIndex:0},this.#i,h(`div.toot-head`,this.#e,this.#t,this.#r,h(`img.toot-author-avatar`,{src:t.avatar_static}),h(`span.toot-author`,c(t.display_name,t.emojis)),h(`span.toot-acct`,`@`+t.acct),h(`span.fill`,a,h(`span.visibility`,e.visibility),be(e),e.edited_at?[h(`span.toot-created.line-through`,u(e.created_at)),h(`span.toot-edited`,u(e.edited_at))]:h(`span.toot-created`,u(e.created_at)))),()=>{let t,o=h(`div.toot-body`,t=h(`div.toot-content`,r(e.content),ee(e.emojis)),e.media_attachments?.length?()=>{let t=h(`ul.attachments`,e.media_attachments.map(e=>h(`li.attachment`,h(`img.preview`,{src:e.preview_url,alt:e.description??``,title:e.description??``}),e.url&&s(`media-link`,e.url,`→ ${e.type}`))));return e.sensitive?h(`details.sensitive`,h(`summary`),t):t}:void 0,n&&h(`div.poll`,h(`ul.poll`,n.options.map((e,t)=>h(`li.poll-option`,h(`span.poll-option-title`,(n.own_votes??[]).includes(t)?n.multiple?`☑`:`⦿︎`:n.multiple?`☐`:`⚪︎`,` `,e.title),h(`span.poll-option-votes`,e.votes_count?.toString(),`/`,n.voters_count?.toString())))),n.voters_count===n.votes_count?null:h(`div.poll-votes-count`,`total votes: `,n.votes_count.toString()),h(`div.poll-expiry`,e=>e.classList.add(n.expired?`poll-expired`:`poll-ongoing`),n.expires_at&&u(n.expires_at))),i&&h(`div.card`,i.image?h(`img.card-image`,{src:i.image,alt:i.image_description??``,title:i.image_description??``,width:i.width??void 0,height:i.height??void 0}):void 0,function*(){i.provider_name&&(yield i.provider_url?s(`card-provider`,i.provider_url,i.provider_name):i.provider_name),yield s(`card-title`,i.url,i.title);let e=(i.authors??[]).filter(e=>e.name);switch(e.length){case 0:i.author_name&&(yield h(`span`,`by `,i.author_url?s(`card-author`,i.author_url,i.author_name):i.author_name));break;case 1:{let{name:t,url:n}=e[0];yield h(`span`,`by `,s(`card-author`,n,t));break}default:yield`by`,yield h(`ul.card-authors`,function*(){for(let{name:t,url:n}of e)yield h(`li`,s(`card-author`,n,t))});break}i.description&&h(`div.card-description`,i.description)}));if(y(t)){let e;m(a,h(`label`,ge(),h(`input`,n=>({type:`checkbox`,onkeydown:e=>{e.key===` `&&e.stopPropagation()},onchange:r=>{r.stopImmediatePropagation(),r.preventDefault(),n.checked?(e=t.cloneNode(!0).childNodes,me(t)):f(t,e)}}))))}return e.spoiler_text&&(o=h(`details`,h(`summary`,e.spoiler_text),o)),o.classList.add(`toot-full-body`),o})}};window.customElements.define(`rendered-toot`,x);function S(e,t,n){let r=e instanceof Array?e:[...e],i=r.length,a=r.findIndex(e=>e===t),o=a;do{o=(o+1)%i;let e=r[o];if(n(e))return e}while(o!==a)}function xe(e,t,n){return S([...e].reverse(),t,n)}var Se=class{disposers=[];register(e){this.disposers.push(e)}disposeAll(){for(let e of this.disposers)e();this.disposers.length=0}};const C=(e,t,n)=>h(`button.menu-entry-with-key-hint`,h(`span`,e),h(`span`,t.map((e,t)=>[t===0?null:` + `,h(`span.keyboard`,e)])),{onclick:n});var w=new Se;function T(e){w.register(te(e))}var E=await e,D=new URLSearchParams(location.hash.substring(1));try{let e=D.get(`url`);if(e){let[t,n]=i(e)??Ce();D.delete(`url`),D.set(`instance`,t),D.set(`id`,n),window.history.replaceState({},``,`#`+D),await E.get(`treeOverview`,`${t}/${n}`)||l(t,n)}}catch(e){alert(`something went wrong when adapting the hash: ${e}`)}function Ce(){throw window.close(),alert(`Could not close this window automatically.  Please close it manually.`),`Window was closed neither automatically nor manually.`}var O=D.get(`instance`),k=D.get(`id`),A=`${O}/${k}`;n(`followToots`,{async updatedTreeOverview(e){e===A&&$(!1)},async updatedTree(e){e===A&&$(!0)},async deletedTree(e){e===A&&$(!0)},cleared(){$(!0)}});var j,M,N=[],P=new Map;async function we(){j&&a({...j,seenIds:new Set})}async function Te(){j&&M&&a({...j,seenIds:new Set(N.map(e=>d(e)))})}var F=p(void 0,{name:`linkConfig`});async function I(){F.value=(await E.get(`config`,`links`)).value}new BroadcastChannel(`linkConfig`).addEventListener(`message`,I),I();var L=document.querySelector(`#context-menu`);{function e(){g.disabled=!L.checked}L.onchange=e,e()}var R=new Map,z=[];function B(e,t){z.push(e);let n=R.get(e);return n.headerPrefix=t,n}function V(e){if(!e)return;let t=R.get(e);t&&(t.focus({preventScroll:!0}),t.scrollIntoView({block:`center`,behavior:`smooth`}))}function H(e){let t=z.findIndex(t=>t===e);t<0||V(z[(t+1)%z.length])}function U(e){let t=z.length,n=z.findIndex(t=>t===e);n<0||V(z[(n-1+t)%t])}function W(e){V(S(z,e,e=>!P.get(d(e))?.value))}function G(e){V(xe(z,e,e=>!P.get(d(e))?.value))}var K=(e,t)=>{let n=P.get(d(e)),r=n.value,i=F.value;return[C(r?`☐ Mark toot as unseen`:`☑ Mark toot as seen`,[`Space`],()=>{n.value=!r,setTimeout(()=>{t.scrollIntoView({block:`center`,behavior:`smooth`}),t.focus()},100)}),C(`Previous unseen toot`,[`Ctrl`,`⬅`],()=>G(e)),C(`Previous toot`,[`⬅`],()=>U(e)),C(`Next toot`,[`➡`],()=>H(e)),C(`Next unseen toot`,[`Ctrl`,`➡`],()=>W(e)),function*(){for(let t of ne){let n=i[t];for(let r in n)if(n[r]){let n=ie[r],i=n.urlFunctions[t](O,e);yield h(`button.open-link`,{onclick:()=>window.open(i)},h(`img.link-icon`,{src:n.icon}),` Open ${re[t].toLowerCase()} on ${n.name(O)}`)}}},h(`button.follow-toot`,{onclick:()=>{let t=new URL(`./tree.html`,document.location.href);t.hash=new URLSearchParams({url:`https://${O}/@${e.account.acct}/${e.id}`}).toString(),window.open(t)}},`Follow toot`)]},Ee=(e,t)=>n=>{if(!(n.shiftKey||n.altKey||n.metaKey)){switch(n.key){case`ArrowRight`:n.ctrlKey?W(e):H(e);break;case`ArrowLeft`:n.ctrlKey?G(e):U(e);break;case` `:t.value=!t.value;break;default:return}n.preventDefault(),n.stopImmediatePropagation()}},q=document.querySelector(`#toot-tree`),J=document.querySelector(`#ancestors`),Y=document.querySelector(`#descendants`);function De(e,t){let n=e.findIndex(t);return n<0?{rest:e}:{found:e[n],rest:e.toSpliced(n,1)}}function Oe(e){let t=e.toot.account.id,n=[];for(let r=e;r;){let{found:e,rest:i}=De(r.children,e=>e.toot.account.id===t);n.push({toot:r.toot,children:i.map(Oe)}),r=e}return n}function ke(){let{root:e,descendants:t}=M,n=new Map([e,...t].map(e=>[e.id,{toot:e,children:[]}]));for(let r of t){let{in_reply_to_id:t,in_reply_to_account_id:i}=r;if(!t){console.error(`descendant without uplink:`,r);continue}if(!n.has(t)){let r={toot:{is_missing:!0,id:t,in_reply_to_id:e.id,account:{id:i}},children:[]};n.get(e.id).children.push(r),n.set(t,r)}n.get(t).children.push(n.get(r.id))}let r=Oe(n.get(e.id));function*i(e){let t=0;for(let{toot:n,children:r}of e)yield h(`div.node`,`is_missing`in n?Ae():B(n,e.length===1?void 0:h(`span.thread-pos`,`${++t}/${e.length}`)),function*(){r.length>0&&(yield h(`ul`,function*(){for(let e of r)yield h(`li`,i(e))}))})}Y.classList.add(`tree-root`),Y.classList.add(`chrono`),f(Y,i(r))}var Ae=()=>h(`div.missing-toot`,`toot(s) missing/deleted/inaccessible`);function je(){let{root:e,descendants:t}=M;f(Y,[e,...t].map(e=>h(`div.node`,B(e))))}var X=p(!0,{name:`display-tree`});function Z(e,...t){m(document.querySelector(e),...t)}function Q(e,...t){f(document.querySelector(e),...t)}function Me(){if(!j)return;let{rootAuthor:e,rootAccountEmojis:n,rootAuthorAvatar:r,rootAcct:i,rootCreatedAt:a,lastCreatedAt:o,lastRetrievalDate:ee,nToots:s,nUnseen:d}=j;Q(`#tree-head-name`,e?c(e,n):A),Z(`#tree-head-avatar`,{src:r}),Q(`#tree-head-acct`,i?`@${i} on ${O}`:``),Q(`#tree-head-date-from`,u(a)),Q(`#tree-head-date-to`,u(o)),Q(`#tree-head-date-fetched`,u(ee)),Q(`#n-toots`,s?.toFixed()??`??`),Q(`#n-unseen`,d?.toFixed()??`??`),Z(`#all-seen`,{onclick:()=>Te()}),Z(`#all-unseen`,{onclick:()=>we()}),Z(`#reload`,{onclick:()=>l(O,k)}),Z(`#remove`,{onclick:()=>t(j)}),Z(`#display-tree`,{onchange:e=>X.value=e.currentTarget.checked})}function Ne(){Q(`#toot-id`,k),Q(`#toot-instance`,O),Z(`#follow`,{onclick:()=>l(O,k)}),J.replaceChildren(),Y.replaceChildren()}function Pe(){T(()=>{f(J,M.ancestors.map((e,t,n)=>[h(`div.node`,B(e)),X.value&&(n.at(t+1)??M.root).in_reply_to_id!==e.id?h(`div.node`,Ae()):void 0]))})}async function Fe(){let e=new Map;for(let t of N){let n=e.get(t.account.acct);n?n.n++:e.set(t.account.acct,{n:1,account:t.account})}let t=[...e.values()];t.sort((e,t)=>t.n-e.n),Q(`#n-users`,t.length.toString()),Q(`#user-stats`,t.map(({n:e,account:t})=>h(`span`,h(`img`,{src:t.avatar_static,title:`${t.display_name} @${t.acct}`}),e>1?e.toString():null))),w.disposeAll(),P.clear();for(let e of N){let t=d(e),n=p(j?.seenIds.has(t)??!1);T(()=>{let e=n.value??!1;if(!j)return;let{seenIds:r}=j;r.has(t)!==e&&(e?r.add(t):r.delete(t),a(j))}),P.set(t,n)}R.clear();for(let e of N){let t=P.get(d(e)),n=m(new x(e),{contextMenuItemProvider:K,dropDownMenuItemProvider:K,onseenchange:e=>t.value=e.detail,onkeydown:Ee(e,t),ondblclick:()=>t.value=!t.value});T(()=>{n.seen=t.value}),R.set(e,n)}z.length=0,Pe(),T(()=>{z.length=M.ancestors.length,X.value?(q.classList.add(`tree`),ke()):(q.classList.remove(`tree`),je())}),V(M?.root)}async function $(e){if(j=await E.get(`treeOverview`,A),Z(`#app`,{hidden:!j}),Z(`#not-following`,{hidden:!!j}),!j){Ne();return}if(document.title=`${j.rootAuthor}: "${j.teaser}"`,document.querySelector(`link[rel='shortcut icon']`).href=j.rootAuthorAvatar??``,Me(),e){if(M=await E.get(`treeDetails`,A),!M){document.title=j.rootAuthor??`Follow Toot`;return}let{ancestors:e,root:t,descendants:n}=M;N=[...e,t,...n],await Fe()}else{if(!M)return;let{seenIds:e}=j;for(let t of N){let n=d(t),r=P.get(n);r?r.value=e.has(n):console.warn(`Misssing "seen" signal for toot ${n}`)}}}$(!0);